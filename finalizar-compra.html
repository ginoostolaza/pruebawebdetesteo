<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Pago Seguro | Binary Edge Academy</title>

  <link rel="icon" href="assets/img/branding/logo-favicon.png" type="image/png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/checkout.css">
  <link rel="stylesheet" href="assets/css/footer.css">

  <meta name="description" content="Pago seguro para acceder a la comunidad de trading de Binary Edge Academy.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Pago Seguro | Binary Edge Academy">
  <meta property="og:image" content="assets/img/branding/logo.png">
  <meta name="theme-color" content="#0a0e17">
</head>
<body>

<!-- ============================================================
     TOP BAR
     ============================================================ -->
<header class="checkout-topbar">
  <div class="topbar-left">
    <img class="topbar-logo" src="assets/img/branding/logo-favicon.png" alt="Logo" width="36" height="36">
    <span class="topbar-brand">Binary Edge Academy</span>
    <span class="topbar-secure">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Pago seguro
    </span>
  </div>
  <a href="index.html" class="topbar-back">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Volver
  </a>
</header>

<!-- ============================================================
     MAIN CHECKOUT LAYOUT
     ============================================================ -->
<div class="checkout-wrapper">

  <!-- LEFT: Payment Methods -->
  <div class="checkout-main">

    <div>
      <div class="checkout-steps">
        <div class="step completed">
          <span class="step-number">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
          </span>
          <span>Elegir plan</span>
        </div>
        <div class="step-line done"></div>
        <div class="step active">
          <span class="step-number">2</span>
          <span>Metodo de pago</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <span class="step-number">3</span>
          <span>Confirmacion</span>
        </div>
      </div>
      <h1 class="checkout-title">Elegir moneda y metodo de pago</h1>
      <p class="checkout-subtitle">Selecciona en que moneda queres pagar y elegÃ­ el metodo</p>
    </div>

    <!-- Manual payment notice -->
    <div class="manual-payment-banner">
      <div class="manual-payment-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <div class="manual-payment-content">
        <h3>Pagos procesados de forma manual</h3>
        <p>Actualmente todos los pagos se confirman manualmente. Una vez que realices tu pago, envia el comprobante por Instagram a <a href="https://instagram.com/ginoostolaza_" target="_blank" rel="noopener noreferrer">@ginoostolaza_</a> y te daremos acceso en minutos.</p>
      </div>
    </div>

    <!-- Currency Toggle -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Moneda de pago
      </h2>
      <div class="currency-toggle" id="currency-toggle">
        <button class="currency-btn active" data-currency="ars" id="btn-ars">
          <span class="currency-flag">ðŸ‡¦ðŸ‡·</span> Pesos (ARS)
        </button>
        <button class="currency-btn" data-currency="usd" id="btn-usd">
          <span class="currency-flag">ðŸ‡ºðŸ‡¸</span> Dolares (USD)
        </button>
      </div>
    </div>

    <!-- Login required notice (shown if not logged in) -->
    <div class="login-required" id="login-notice" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
      <p>Para pagar necesitas <a href="iniciar-sesion.html">iniciar sesion</a>. Si no tenes cuenta, <a href="iniciar-sesion.html">registrate gratis</a>.</p>
    </div>

    <!-- Already a student link (shown if not logged in) -->
    <a href="iniciar-sesion.html" class="already-student-link" id="already-student-link" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
      Ya soy alumno â€” Iniciar sesion
    </a>

    <!-- Payment Methods -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Pagar con tarjeta
      </h2>

      <div class="payment-methods">

        <!-- MercadoPago Embedded (ARS) -->
        <div class="payment-method" data-method="mercadopago" id="method-mp">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Tarjeta de credito o debito</div>
              <div class="payment-method-desc">Visa, Mastercard, AMEX â€” en pesos argentinos</div>
            </div>
            <span class="payment-method-badge">Seguro</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">
              <div class="detail-note">
                Completa los datos de tu tarjeta directamente aqui. Tu pago se procesa de forma segura a traves de MercadoPago.
              </div>
              <div id="mp-brick-container" class="embedded-form-container"></div>
              <div id="mp-error" class="payment-error-msg"></div>
              <div id="mp-success" class="payment-success-msg" style="display:none;"></div>
              <button class="fallback-toggle" id="mp-fallback-btn" type="button">
                Prefiero pagar en la pagina de MercadoPago
              </button>
            </div>
          </div>
        </div>

        <!-- Stripe Embedded (USD) -->
        <div class="payment-method" data-method="stripe" id="method-stripe" style="display:none;">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon intl">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Tarjeta internacional</div>
              <div class="payment-method-desc">Visa, Mastercard, AMEX â€” en dolares</div>
            </div>
            <span class="payment-method-badge">Seguro</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">
              <div class="detail-note">
                Completa los datos de tu tarjeta directamente aqui. Tu pago se procesa de forma segura a traves de Stripe.
              </div>
              <div id="stripe-form-container" class="embedded-form-container">
                <div id="stripe-loading" class="payment-loading">
                  <span class="spinner"></span> Cargando formulario de pago...
                </div>
                <div id="stripe-payment-element"></div>
                <div id="stripe-error" class="payment-error-msg"></div>
                <button class="btn-confirm-pay stripe" id="btn-confirm-stripe" type="button" style="display:none;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                  Pagar <span id="stripe-confirm-price">USD 10,00</span>
                </button>
              </div>
              <button class="fallback-toggle" id="stripe-fallback-btn" type="button">
                Prefiero pagar en la pagina de Stripe
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="payment-or">o paga manualmente</div>

    <!-- Manual Payment Methods -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Pago manual (con comprobante)
      </h2>

      <div class="note-card">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
        <p>
          Al realizar tu pago manual, envia un mensaje con:
          <em id="nota-mensaje">"Hola, les envio el pago de la Fase 1. Mi nombre es: [Tu nombre]"</em>
        </p>
      </div>

      <div class="payment-methods" style="margin-top: 0.75rem;">

        <!-- Banco Argentino -->
        <div class="payment-method" data-method="banco" id="method-banco">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Transferencia bancaria (ARS/USD)</div>
              <div class="payment-method-desc">Banco Galicia o Mercado Pago</div>
            </div>
            <span class="payment-method-badge">Argentina</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">Banco Galicia â€” Cuenta en dolares</div>
                <div class="detail-row">
                  <span class="detail-label">Alias</span>
                  <span class="detail-value">GINO.OSTOLAZA.GON</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Titular</span>
                  <span class="detail-value">Gonzalez Gino Ostolaza</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CBU</span>
                  <span class="detail-value">0070100230004026120398</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CUIT</span>
                  <span class="detail-value">20-48637004-2</span>
                </div>
              </div>

              <div class="payment-divider"></div>

              <div class="detail-block">
                <div class="detail-block-title">Mercado Pago â€” Cuenta en pesos</div>
                <div class="detail-row">
                  <span class="detail-label">Alias</span>
                  <span class="detail-value">gino.ostolaza</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Titular</span>
                  <span class="detail-value">Gino Ostolaza Gonzalez</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CVU</span>
                  <span class="detail-value">0000003100052857370471</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CUIT</span>
                  <span class="detail-value">20-48637004-2</span>
                </div>
              </div>

              <div class="ars-conversion" id="conversion-banco">
                Equivalente en pesos: <strong class="resultado-transferencia">Cargando...</strong> ARS
              </div>

              <div class="detail-note">
                Podes usar la cuenta en dolares o Mercado Pago en pesos. Una vez hecho el pago, envia el comprobante por Instagram.
              </div>
            </div>
          </div>
        </div>

        <!-- Cripto -->
        <div class="payment-method" data-method="cripto" id="method-cripto">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon cripto">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.215-6.893m-1.215 6.893-6.083-1.072m6.083 1.072.347-1.971m-1.562 8.864-6.083-1.072m7.645-7.893L5.514 9.204m7.645 7.892 1.043-5.922M5.86 18.047l1.043-5.922m0 0-1.389-7.921"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Criptomonedas</div>
              <div class="payment-method-desc">Bitcoin, Ethereum o USDT</div>
            </div>
            <span class="payment-method-badge">Global</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">Redes aceptadas</div>
                <div class="detail-row">
                  <span class="detail-label">Bitcoin</span>
                  <span class="detail-value">BTC Network</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Ethereum</span>
                  <span class="detail-value">ERC-20</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">USDT</span>
                  <span class="detail-value">TRC-20 / ERC-20</span>
                </div>
              </div>

              <div class="detail-note">
                Las direcciones de wallet se comparten exclusivamente por mensaje privado para proteger ambas partes.
              </div>

              <div class="detail-block">
                <p style="font-size: 0.85rem; color: var(--color-text-muted);">
                  Solicita la wallet por Instagram:
                  <a href="https://instagram.com/ginoostolaza_" target="_blank" rel="noopener noreferrer" class="detail-link">@ginoostolaza_</a>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Internacional -->
        <div class="payment-method" data-method="intl" id="method-intl">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon intl">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">PayPal / Skrill (USD)</div>
              <div class="payment-method-desc">Pago internacional manual</div>
            </div>
            <span class="payment-method-badge">Internacional</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">PayPal</div>
                <div class="detail-row">
                  <span class="detail-label">Link de pago</span>
                  <a href="https://paypal.me/GinoOstolaza/" target="_blank" rel="noopener noreferrer" class="detail-link">paypal.me/GinoOstolaza</a>
                </div>
                <p style="font-size:0.8rem;color:var(--color-text-dim);margin-top:0.3rem;">Coloca tu nombre completo en las notas del pago.</p>
              </div>

              <div class="payment-divider"></div>

              <div class="detail-block">
                <div class="detail-block-title">Skrill</div>
                <div class="detail-row">
                  <span class="detail-label">Email</span>
                  <span class="detail-value">ginitoostolaza1@gmail.com</span>
                </div>
                <p style="font-size:0.8rem;color:var(--color-text-dim);margin-top:0.3rem;">Indica tu nombre completo en el campo de mensaje.</p>
              </div>

              <div class="detail-note">
                Para confirmar tu pago o ante cualquier duda, contactanos por Instagram.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Trust badges -->
    <div class="trust-badges">
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Datos protegidos
      </div>
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Pago verificado
      </div>
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
        Acceso inmediato
      </div>
    </div>

  </div>

  <!-- RIGHT: Order Summary Sidebar -->
  <aside class="checkout-sidebar">

    <div class="order-summary">
      <h2 class="summary-title">Resumen del pedido</h2>

      <div class="summary-product" id="summary-product">
        <div class="summary-product-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </div>
        <div class="summary-product-info">
          <div class="summary-product-name" id="summary-name">Fase 1 â€” Comunidad de Trading</div>
          <div class="summary-product-desc" id="summary-desc">Acceso completo al curso + comunidad</div>
        </div>
      </div>

      <div class="summary-row">
        <span class="summary-label">Subtotal</span>
        <span class="summary-value" id="summary-subtotal">$9.999 ARS</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Comision</span>
        <span class="summary-value" style="color: var(--color-success);">$0,00</span>
      </div>

      <div class="summary-divider"></div>

      <div class="summary-total">
        <span class="summary-total-label">Total</span>
        <span class="summary-total-value" id="summary-total">$9.999 ARS</span>
      </div>

      <div class="summary-divider"></div>

      <ul class="summary-benefits" id="summary-benefits">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          2 sistemas de trading probados
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Desarrollo personal y psicotrading
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Acceso a comunidad exclusiva
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Acceso se habilita al instante
        </li>
      </ul>
    </div>

    <!-- Dolar Blue -->
    <div class="dolar-card">
      <div class="dolar-card-title">Cotizacion de referencia</div>
      <div class="dolar-card-value" id="dolar-blue">Consultando dolar blue...</div>
      <div class="dolar-card-note">Referencia: dolar blue (venta)</div>
    </div>

    <!-- Contact -->
    <div class="contact-card">
      <p>Ya pagaste o tenes dudas? Escribinos directamente.</p>
      <a href="https://instagram.com/ginoostolaza_" target="_blank" rel="noopener noreferrer" class="contact-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        Contactar por Instagram
      </a>
    </div>

    <!-- Login -->
    <a href="iniciar-sesion.html" class="login-link" id="sidebar-login">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
      Ya soy alumno â€” Iniciar sesion
    </a>

  </aside>
</div>

<div id="footer"></div>
<script src="assets/js/footer.js"></script>

<!-- Payment SDKs -->
<script src="https://js.stripe.com/v3/"></script>
<script src="https://sdk.mercadopago.com/js/v2"></script>

<!-- Supabase (to check login state) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js"></script>
<script src="assets/js/auth.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    // --- Detect plan from URL ---
    const params = new URLSearchParams(window.location.search);
    const plan = params.get('plan') || 'fase1';
    const isBot = plan === 'bot';

    // --- Pricing ---
    const PRICES = {
      fase1: { ars: 9999, usd: 10 },
      bot:   { ars: 7500, usd: 5 }
    };
    const prices = PRICES[plan] || PRICES.fase1;
    let currentCurrency = 'ars';

    // --- Payment SDK state ---
    let paymentKeys = { stripe_publishable_key: '', mercadopago_public_key: '' };
    let stripeInstance = null;
    let stripeElements = null;
    let stripeIntentCreated = false;
    let mpBrickMounted = false;
    let mpInstance = null;

    // --- Check if user is logged in ---
    Auth.init();
    let userData = null;
    const storedUser = sessionStorage.getItem('usuario');
    const isLoggedIn = sessionStorage.getItem('accesoAutorizado') === 'true' && storedUser;

    if (isLoggedIn) {
      userData = JSON.parse(storedUser);
      document.getElementById('login-notice').style.display = 'none';
      document.getElementById('sidebar-login').style.display = 'none';
      document.getElementById('already-student-link').style.display = 'none';
    } else {
      document.getElementById('login-notice').style.display = 'flex';
      document.getElementById('already-student-link').style.display = 'flex';
    }

    // --- Fetch payment config (public keys) ---
    try {
      const configRes = await fetch('/api/payment-config');
      if (configRes.ok) {
        paymentKeys = await configRes.json();
      }
    } catch (e) {
      console.warn('Could not fetch payment config:', e);
    }

    // --- Update product info based on plan ---
    if (isBot) {
      document.getElementById('summary-name').textContent = 'Bot de Trading â€” Suscripcion Mensual';
      document.getElementById('summary-desc').textContent = 'Bot automatizado configurado por Binary Edge';
      document.getElementById('nota-mensaje').textContent =
        '"Hola, les envio el pago del Bot de Trading. Mi nombre es: [Tu nombre]"';
      document.title = 'Bot de Trading | Pago Seguro';

      document.querySelector('.summary-product-icon').innerHTML =
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.07A7 7 0 0 1 14 23h-4a7 7 0 0 1-6.93-4H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="16" r="1" fill="currentColor"/><circle cx="15" cy="16" r="1" fill="currentColor"/></svg>';

      const benefits = document.getElementById('summary-benefits');
      benefits.innerHTML =
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Opera automaticamente 24/7</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Configurado por nuestro equipo</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Actualizaciones incluidas</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Acceso se habilita al instante</li>';
    }

    // --- Format helpers ---
    function fmtARS(n) { return '$' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ARS'; }
    function fmtUSD(n) { return 'USD ' + n.toFixed(2).replace('.', ','); }

    // --- Update displayed prices ---
    function updatePrices() {
      const isARS = currentCurrency === 'ars';
      const priceStr = isARS ? fmtARS(prices.ars) : fmtUSD(prices.usd);

      document.getElementById('summary-subtotal').textContent = priceStr;
      document.getElementById('summary-total').textContent = priceStr;

      const confirmPrice = document.getElementById('stripe-confirm-price');
      if (confirmPrice) confirmPrice.textContent = fmtUSD(prices.usd);

      // Show/hide payment methods based on currency
      document.getElementById('method-mp').style.display = isARS ? 'block' : 'none';
      document.getElementById('method-stripe').style.display = isARS ? 'none' : 'block';

      // Deselect current method when currency changes
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
    }

    // --- Currency toggle ---
    document.querySelectorAll('.currency-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCurrency = btn.dataset.currency;
        updatePrices();
      });
    });

    // Initial price update
    updatePrices();

    // --- Payment method selection ---
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', (e) => {
        // Don't toggle if clicking inside the embedded form or a button
        if (e.target.closest('.embedded-form-container') ||
            e.target.closest('.btn-confirm-pay') ||
            e.target.closest('.fallback-toggle')) return;

        const wasSelected = method.classList.contains('selected');
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));

        if (!wasSelected) {
          method.classList.add('selected');
          const methodType = method.dataset.method;

          // Initialize embedded forms on first selection
          if (methodType === 'stripe' && !stripeIntentCreated && isLoggedIn) {
            initStripeEmbed();
          }
          if (methodType === 'mercadopago' && !mpBrickMounted && isLoggedIn) {
            initMPBrick();
          }
        }
      });
    });

    // ============================================================
    // STRIPE EMBEDDED PAYMENT ELEMENT
    // ============================================================
    async function initStripeEmbed() {
      if (!paymentKeys.stripe_publishable_key) {
        showError('stripe-error', 'Configuracion de Stripe no disponible. Usa el metodo alternativo.');
        return;
      }
      if (!isLoggedIn) {
        showError('stripe-error', 'Necesitas iniciar sesion para pagar.');
        return;
      }

      const loadingEl = document.getElementById('stripe-loading');
      const confirmBtn = document.getElementById('btn-confirm-stripe');

      try {
        // Create PaymentIntent
        const res = await fetch('/api/stripe-create-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: plan,
            user_id: userData.id,
            user_email: userData.email,
            user_nombre: userData.nombre
          })
        });

        const data = await res.json();
        if (!data.clientSecret) throw new Error(data.error || 'Error al crear intent');

        // Initialize Stripe
        stripeInstance = Stripe(paymentKeys.stripe_publishable_key);
        stripeElements = stripeInstance.elements({
          clientSecret: data.clientSecret,
          appearance: {
            theme: 'night',
            variables: {
              colorPrimary: '#635bff',
              colorBackground: '#0a0e17',
              colorText: '#e8edf5',
              colorTextSecondary: '#8b95a8',
              colorDanger: '#ef4444',
              fontFamily: 'Poppins, system-ui, sans-serif',
              borderRadius: '8px',
              spacingUnit: '4px'
            },
            rules: {
              '.Input': {
                border: '1px solid rgba(255, 255, 255, 0.1)',
                backgroundColor: '#131a2b',
                color: '#e8edf5',
                padding: '12px'
              },
              '.Input:focus': {
                border: '1px solid #635bff',
                boxShadow: '0 0 0 1px #635bff'
              },
              '.Label': {
                color: '#8b95a8',
                fontWeight: '500'
              }
            }
          }
        });

        // Mount Payment Element
        const paymentElement = stripeElements.create('payment', {
          layout: 'tabs'
        });
        paymentElement.mount('#stripe-payment-element');

        paymentElement.on('ready', () => {
          loadingEl.style.display = 'none';
          confirmBtn.style.display = 'flex';
          confirmBtn.disabled = false;
          stripeIntentCreated = true;
        });

        paymentElement.on('change', (event) => {
          if (event.error) {
            showError('stripe-error', event.error.message);
          } else {
            hideError('stripe-error');
          }
        });

      } catch (err) {
        console.error('Stripe embed init error:', err);
        loadingEl.innerHTML = 'No se pudo cargar el formulario. Usa el metodo alternativo.';
      }
    }

    // Stripe confirm payment
    const confirmStripeBtn = document.getElementById('btn-confirm-stripe');
    if (confirmStripeBtn) {
      confirmStripeBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!stripeInstance || !stripeElements) return;

        confirmStripeBtn.disabled = true;
        confirmStripeBtn.innerHTML = '<span class="spinner"></span> Procesando pago...';
        hideError('stripe-error');

        const siteUrl = window.location.origin;
        const returnUrl = siteUrl + '/pago-resultado.html?status=success&provider=stripe&producto=' + plan;

        const { error } = await stripeInstance.confirmPayment({
          elements: stripeElements,
          confirmParams: {
            return_url: returnUrl
          }
        });

        if (error) {
          showError('stripe-error', error.message);
          confirmStripeBtn.disabled = false;
          confirmStripeBtn.innerHTML =
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Pagar ' + fmtUSD(prices.usd);
        }
        // If no error, Stripe redirects automatically
      });
    }

    // Stripe fallback (redirect to hosted checkout)
    const stripeFallbackBtn = document.getElementById('stripe-fallback-btn');
    if (stripeFallbackBtn) {
      stripeFallbackBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!isLoggedIn) {
          alert('Necesitas iniciar sesion para pagar.');
          window.location.href = 'iniciar-sesion.html';
          return;
        }

        stripeFallbackBtn.disabled = true;
        stripeFallbackBtn.textContent = 'Redirigiendo...';

        try {
          const response = await fetch('/api/stripe-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              producto_id: plan,
              user_id: userData.id,
              user_email: userData.email,
              user_nombre: userData.nombre
            })
          });
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error(data.error || 'Error');
          }
        } catch (err) {
          alert('Error al redirigir. Intenta de nuevo.');
          stripeFallbackBtn.disabled = false;
          stripeFallbackBtn.textContent = 'Prefiero pagar en la pagina de Stripe';
        }
      });
    }

    // ============================================================
    // MERCADOPAGO CHECKOUT BRICKS
    // ============================================================
    async function initMPBrick() {
      if (!paymentKeys.mercadopago_public_key) {
        showError('mp-error', 'Configuracion de MercadoPago no disponible. Usa el metodo alternativo.');
        return;
      }
      if (!isLoggedIn) {
        showError('mp-error', 'Necesitas iniciar sesion para pagar.');
        return;
      }

      const container = document.getElementById('mp-brick-container');
      container.innerHTML = '<div class="payment-loading"><span class="spinner"></span> Cargando formulario de pago...</div>';

      try {
        mpInstance = new MercadoPago(paymentKeys.mercadopago_public_key, {
          locale: 'es-AR'
        });

        const bricksBuilder = mpInstance.bricks();

        await bricksBuilder.create('cardPayment', 'mp-brick-container', {
          initialization: {
            amount: prices.ars
          },
          customization: {
            visual: {
              style: {
                theme: 'dark',
                customVariables: {
                  formBackgroundColor: '#0a0e17',
                  baseColor: '#3b82f6'
                }
              }
            },
            paymentMethods: {
              maxInstallments: 12
            }
          },
          callbacks: {
            onReady: () => {
              mpBrickMounted = true;
            },
            onSubmit: async (cardFormData) => {
              hideError('mp-error');
              try {
                const response = await fetch('/api/mercadopago-process', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    ...cardFormData,
                    transaction_amount: prices.ars,
                    producto_id: plan,
                    user_id: userData.id
                  })
                });

                const result = await response.json();

                if (result.status === 'approved') {
                  window.location.href = 'pago-resultado.html?status=success&provider=mercadopago&producto=' + plan + '&payment_id=' + result.id;
                } else if (result.status === 'in_process' || result.status === 'pending') {
                  window.location.href = 'pago-resultado.html?status=pending&provider=mercadopago&producto=' + plan;
                } else {
                  const msg = getMPErrorMessage(result.status_detail);
                  showError('mp-error', msg);
                }
              } catch (err) {
                console.error('MP process error:', err);
                showError('mp-error', 'Error al procesar el pago. Intenta de nuevo.');
              }
            },
            onError: (error) => {
              console.error('MP Brick error:', error);
            }
          }
        });

      } catch (err) {
        console.error('MP Brick init error:', err);
        container.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--color-text-muted);font-size:0.85rem;">No se pudo cargar el formulario. Usa el metodo alternativo.</div>';
      }
    }

    // MercadoPago error messages
    function getMPErrorMessage(statusDetail) {
      const messages = {
        'cc_rejected_bad_filled_card_number': 'Revisa el numero de tarjeta.',
        'cc_rejected_bad_filled_date': 'Revisa la fecha de vencimiento.',
        'cc_rejected_bad_filled_other': 'Revisa los datos ingresados.',
        'cc_rejected_bad_filled_security_code': 'Revisa el codigo de seguridad.',
        'cc_rejected_blacklist': 'No pudimos procesar tu pago. Usa otra tarjeta.',
        'cc_rejected_call_for_authorize': 'Debes autorizar el pago con tu banco.',
        'cc_rejected_card_disabled': 'Tu tarjeta esta deshabilitada. Contacta a tu banco.',
        'cc_rejected_duplicated_payment': 'Ya realizaste un pago con este monto. Si necesitas volver a pagar, espera unos minutos.',
        'cc_rejected_high_risk': 'Tu pago fue rechazado. Usa otra tarjeta.',
        'cc_rejected_insufficient_amount': 'Fondos insuficientes.',
        'cc_rejected_invalid_installments': 'Tu tarjeta no acepta esta cantidad de cuotas.',
        'cc_rejected_max_attempts': 'Llegaste al limite de intentos. Usa otra tarjeta.',
        'cc_rejected_other_reason': 'Tu pago fue rechazado. Intenta con otra tarjeta.'
      };
      return messages[statusDetail] || 'El pago fue rechazado. Intenta con otra tarjeta o usa otro metodo.';
    }

    // MercadoPago fallback (redirect to Checkout Pro)
    const mpFallbackBtn = document.getElementById('mp-fallback-btn');
    if (mpFallbackBtn) {
      mpFallbackBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!isLoggedIn) {
          alert('Necesitas iniciar sesion para pagar.');
          window.location.href = 'iniciar-sesion.html';
          return;
        }

        mpFallbackBtn.disabled = true;
        mpFallbackBtn.textContent = 'Redirigiendo...';

        try {
          const response = await fetch('/api/mercadopago-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              producto_id: plan,
              user_id: userData.id,
              user_email: userData.email,
              user_nombre: userData.nombre
            })
          });
          const data = await response.json();
          if (data.init_point) {
            window.location.href = data.init_point;
          } else {
            throw new Error(data.error || 'Error');
          }
        } catch (err) {
          alert('Error al redirigir. Intenta de nuevo.');
          mpFallbackBtn.disabled = false;
          mpFallbackBtn.textContent = 'Prefiero pagar en la pagina de MercadoPago';
        }
      });
    }

    // ============================================================
    // HELPERS
    // ============================================================
    function showError(id, msg) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
        el.classList.add('visible');
        el.style.display = 'block';
      }
    }

    function hideError(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove('visible');
        el.style.display = 'none';
      }
    }

    // --- Dolar Blue API ---
    fetch("https://api.bluelytics.com.ar/v2/latest")
      .then(r => r.json())
      .then(data => {
        const dolarBlue = data.blue.value_sell;

        const dolarEl = document.getElementById("dolar-blue");
        if (dolarEl) {
          dolarEl.textContent = '$' + dolarBlue.toFixed(2) + ' ARS';
        }

        // Show ARS equivalent for bank transfer
        const resultado = prices.usd * dolarBlue;
        const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        document.querySelectorAll(".resultado-transferencia").forEach(span => {
          span.textContent = '$' + fmt(Math.round(resultado));
        });
      })
      .catch(() => {
        const dolarEl = document.getElementById("dolar-blue");
        if (dolarEl) dolarEl.textContent = "No disponible";
      });

    // --- Tab title ---
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        document.title = "Completar pago";
      } else {
        document.title = isBot ? "Bot de Trading | Pago Seguro" : "Pago Seguro | Binary Edge Academy";
      }
    });
  });
</script>

</body>
</html>
