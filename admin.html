<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Panel Admin | Binary Edge Academy</title>

  <!-- Auth + Admin guard -->
  <script>
    (function () {
      var acceso = sessionStorage.getItem("accesoAutorizado");
      var usuario = JSON.parse(sessionStorage.getItem("usuario") || "{}");
      if (!acceso || acceso !== "true") { window.location.replace("iniciar-sesion.html"); }
      if (usuario.rol !== "admin") { window.location.replace("dashboard.html"); }
    })();
  </script>

  <link rel="icon" href="assets/img/branding/logo-favicon.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/admin.css">
  <meta name="theme-color" content="#0a0e17">
</head>
<body>

<!-- NAV -->
<nav class="admin-nav">
  <div class="admin-nav-left">
    <img src="assets/img/branding/logo-favicon.png" alt="Logo" width="32" height="32" style="border-radius:8px">
    <span class="admin-nav-brand">Panel de Administracion</span>
    <span class="admin-nav-tag">Admin</span>
  </div>
  <div class="admin-nav-right">
    <a href="dashboard.html" class="nav-link-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Dashboard
    </a>
    <button class="btn-logout" id="btn-logout">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      Salir
    </button>
  </div>
</nav>

<div class="admin-container">

  <!-- Stats Overview -->
  <div class="admin-stats" id="admin-stats">
    <div class="admin-stat">
      <div class="admin-stat-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </div>
      <div class="admin-stat-value" id="stat-total-users">-</div>
      <div class="admin-stat-label">Usuarios totales</div>
    </div>
    <div class="admin-stat">
      <div class="admin-stat-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
      </div>
      <div class="admin-stat-value" id="stat-active-users">-</div>
      <div class="admin-stat-label">Usuarios activos</div>
    </div>
    <div class="admin-stat">
      <div class="admin-stat-icon purple">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.07A7 7 0 0 1 14 23h-4a7 7 0 0 1-6.93-4H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/></svg>
      </div>
      <div class="admin-stat-value" id="stat-bot-users">-</div>
      <div class="admin-stat-label">Suscriptores bot</div>
    </div>
    <div class="admin-stat">
      <div class="admin-stat-icon orange">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      </div>
      <div class="admin-stat-value" id="stat-revenue">-</div>
      <div class="admin-stat-label">Ingresos totales</div>
    </div>
  </div>

  <!-- Secondary Stats -->
  <div class="admin-stats-secondary">
    <div class="admin-stat-mini">
      <span class="stat-mini-label">Con Fase 1</span>
      <span class="stat-mini-value" id="stat-fase1">-</span>
    </div>
    <div class="admin-stat-mini">
      <span class="stat-mini-label">Con Ambas</span>
      <span class="stat-mini-value" id="stat-ambas">-</span>
    </div>
    <div class="admin-stat-mini">
      <span class="stat-mini-label">Sin acceso</span>
      <span class="stat-mini-value" id="stat-no-access">-</span>
    </div>
    <div class="admin-stat-mini">
      <span class="stat-mini-label">Pagos completados</span>
      <span class="stat-mini-value" id="stat-completed-payments">-</span>
    </div>
    <div class="admin-stat-mini">
      <span class="stat-mini-label">Pagos pendientes</span>
      <span class="stat-mini-value" id="stat-pending-payments">-</span>
    </div>
    <div class="admin-stat-mini">
      <span class="stat-mini-label">En comunidad</span>
      <span class="stat-mini-value" id="stat-comunidad">-</span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="admin-tabs">
    <button class="admin-tab active" data-tab="users">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Usuarios
    </button>
    <button class="admin-tab" data-tab="payments">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Pagos
    </button>
    <button class="admin-tab" data-tab="actions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Acciones rapidas
    </button>
  </div>

  <!-- ============ USERS TAB ============ -->
  <div class="admin-panel active" id="panel-users">
    <div class="panel-header">
      <h2>Gestion de Usuarios</h2>
      <div class="panel-actions">
        <input type="text" id="user-search" class="admin-search" placeholder="Buscar por nombre o email...">
        <select id="user-filter" class="admin-select">
          <option value="all">Todos</option>
          <option value="activo">Activos</option>
          <option value="suspendido">Suspendidos</option>
          <option value="inactivo">Inactivos</option>
          <option value="admin">Admins</option>
          <option value="bot">Suscriptores Bot</option>
          <option value="fase-1">Con Fase 1</option>
          <option value="ambas">Con Ambas Fases</option>
          <option value="sin-acceso">Sin acceso</option>
          <option value="comunidad">En comunidad</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Fase</th>
            <th>Bot</th>
            <th>Comunidad</th>
            <th>Estado</th>
            <th>Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="users-table-body">
          <tr><td colspan="9" class="table-loading">Cargando usuarios...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ PAYMENTS TAB ============ -->
  <div class="admin-panel" id="panel-payments">
    <div class="panel-header">
      <h2>Registro de Pagos</h2>
      <div class="panel-actions">
        <select id="payment-filter" class="admin-select">
          <option value="all">Todos</option>
          <option value="completado">Completados</option>
          <option value="pendiente">Pendientes</option>
          <option value="fallido">Fallidos</option>
        </select>
        <button class="btn-primary" id="btn-add-payment">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Registrar pago
        </button>
      </div>
    </div>

    <div class="table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Monto</th>
            <th>Metodo</th>
            <th>Concepto</th>
            <th>Estado</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="payments-table-body">
          <tr><td colspan="6" class="table-loading">Cargando pagos...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ QUICK ACTIONS TAB ============ -->
  <div class="admin-panel" id="panel-actions">
    <div class="panel-header">
      <h2>Acciones Rapidas</h2>
    </div>

    <div class="quick-actions-grid">
      <!-- Grant access -->
      <div class="action-card">
        <div class="action-card-icon blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <h4>Dar acceso a curso</h4>
        <p>Asigna Fase 1, Fase 2 o Ambas a un usuario</p>
        <div class="action-card-form">
          <select id="qa-access-user" class="admin-select qa-select"></select>
          <select id="qa-access-fase" class="admin-select qa-select">
            <option value="fase-1">Fase 1</option>
            <option value="fase-2">Fase 2</option>
            <option value="ambas">Ambas Fases</option>
          </select>
          <button class="btn-primary btn-sm" id="btn-qa-access">Dar acceso</button>
        </div>
      </div>

      <!-- Toggle Bot + License -->
      <div class="action-card">
        <div class="action-card-icon purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.07A7 7 0 0 1 14 23h-4a7 7 0 0 1-6.93-4H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/></svg>
        </div>
        <h4>Activar Bot + Licencia</h4>
        <p>Activa el bot y asigna una licencia al usuario</p>
        <div class="action-card-form">
          <select id="qa-bot-user" class="admin-select qa-select"></select>
          <input type="text" id="qa-bot-license" class="admin-search qa-select" placeholder="Licencia (auto-genera si vacio)">
          <button class="btn-primary btn-sm" id="btn-qa-bot-on">Activar + Licencia</button>
          <button class="btn-danger btn-sm" id="btn-qa-bot-off">Desactivar</button>
        </div>
      </div>

      <!-- Suspend user -->
      <div class="action-card">
        <div class="action-card-icon orange">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
        </div>
        <h4>Suspender usuario</h4>
        <p>Bloquea el acceso de un usuario a la plataforma</p>
        <div class="action-card-form">
          <select id="qa-suspend-user" class="admin-select qa-select"></select>
          <button class="btn-danger btn-sm" id="btn-qa-suspend">Suspender</button>
          <button class="btn-primary btn-sm" id="btn-qa-reactivate">Reactivar</button>
        </div>
      </div>

      <!-- Community access -->
      <div class="action-card">
        <div class="action-card-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <h4>Acceso a Comunidad</h4>
        <p>Otorga o revoca acceso a la comunidad privada</p>
        <div class="action-card-form">
          <select id="qa-comunidad-user" class="admin-select qa-select"></select>
          <button class="btn-primary btn-sm" id="btn-qa-comunidad-on">Dar acceso</button>
          <button class="btn-danger btn-sm" id="btn-qa-comunidad-off">Revocar acceso</button>
        </div>
      </div>

      <!-- Send notification -->
      <div class="action-card">
        <div class="action-card-icon cyan">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        </div>
        <h4>Enviar notificacion</h4>
        <p>Envia una notificacion a un usuario o a todos</p>
        <div class="action-card-form">
          <select id="qa-notif-user" class="admin-select qa-select">
            <option value="all">Todos los usuarios</option>
          </select>
          <select id="qa-notif-type" class="admin-select qa-select">
            <option value="info">Informacion</option>
            <option value="success">Exito</option>
            <option value="warning">Advertencia</option>
            <option value="error">Urgente</option>
          </select>
          <input type="text" id="qa-notif-title" class="admin-search qa-select" placeholder="Titulo de la notificacion">
          <textarea id="qa-notif-message" class="admin-search qa-select" rows="2" placeholder="Mensaje..." style="resize:vertical;min-height:60px;"></textarea>
          <button class="btn-primary btn-sm" id="btn-qa-notif-send">Enviar notificacion</button>
        </div>
      </div>

      <!-- Export data -->
      <div class="action-card">
        <div class="action-card-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </div>
        <h4>Exportar datos</h4>
        <p>Descarga la informacion de usuarios y pagos en CSV</p>
        <div class="action-card-form">
          <button class="btn-primary btn-sm" id="btn-export-users">Exportar usuarios</button>
          <button class="btn-primary btn-sm" id="btn-export-payments">Exportar pagos</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ============ MODAL: Edit User ============ -->
<div class="modal-overlay" id="modal-edit-user">
  <div class="modal-card">
    <div class="modal-bar-blue"></div>
    <h3>Editar Usuario</h3>
    <form id="form-edit-user">
      <input type="hidden" id="edit-user-id">
      <div class="modal-field">
        <label>Nombre</label>
        <input type="text" id="edit-user-name">
      </div>
      <div class="modal-field">
        <label>Rol</label>
        <select id="edit-user-role">
          <option value="alumno">Alumno</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Fase</label>
        <select id="edit-user-fase">
          <option value="">Sin acceso</option>
          <option value="fase-1">Fase 1</option>
          <option value="fase-2">Fase 2</option>
          <option value="ambas">Ambas</option>
        </select>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>Estado</label>
          <select id="edit-user-status">
            <option value="activo">Activo</option>
            <option value="suspendido">Suspendido</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Bot de Trading</label>
          <div class="toggle-wrapper">
            <label class="toggle-switch">
              <input type="checkbox" id="edit-user-bot">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label" id="edit-bot-label">Inactivo</span>
          </div>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>Comunidad Privada</label>
          <div class="toggle-wrapper">
            <label class="toggle-switch">
              <input type="checkbox" id="edit-user-comunidad">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label" id="edit-comunidad-label">Sin acceso</span>
          </div>
        </div>
      </div>
      <div class="modal-field" id="edit-license-field" style="display:none">
        <label>Licencia del Bot</label>
        <div class="license-input-row">
          <input type="text" id="edit-user-license" placeholder="Ej: GBOT-XXXX-XXXX-XXXX" class="input-license">
          <button type="button" class="btn-generate-license" id="btn-generate-license" title="Generar licencia">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          </button>
        </div>
      </div>
      <div class="modal-field">
        <label>Notas</label>
        <textarea id="edit-user-notes" rows="3" placeholder="Notas internas..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeModal('modal-edit-user')">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- ============ MODAL: Add Payment ============ -->
<div class="modal-overlay" id="modal-add-payment">
  <div class="modal-card">
    <div class="modal-bar-green"></div>
    <h3>Registrar Pago</h3>
    <form id="form-add-payment">
      <div class="modal-field">
        <label>Usuario</label>
        <select id="payment-user" required></select>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>Monto</label>
          <input type="number" id="payment-amount" step="0.01" required placeholder="0.00">
        </div>
        <div class="modal-field">
          <label>Moneda</label>
          <select id="payment-currency">
            <option value="USD">USD</option>
            <option value="ARS">ARS</option>
          </select>
        </div>
      </div>
      <div class="modal-field">
        <label>Metodo de pago</label>
        <select id="payment-method">
          <option value="MercadoPago">MercadoPago</option>
          <option value="Transferencia">Transferencia</option>
          <option value="PayPal">PayPal</option>
          <option value="Skrill">Skrill</option>
          <option value="Cripto">Criptomonedas</option>
          <option value="Efectivo">Efectivo</option>
        </select>
      </div>
      <div class="modal-field">
        <label>Concepto</label>
        <input type="text" id="payment-concept" placeholder="Ej: Fase 1 - Pago unico">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeModal('modal-add-payment')">Cancelar</button>
        <button type="submit" class="btn-primary">Registrar pago</button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js"></script>
<script src="assets/js/auth.js"></script>

<script>
  let allUsers = [];
  let allPayments = [];

  document.addEventListener("DOMContentLoaded", async () => {
    Auth.init();
    await Auth.adminGuard();
    await loadData();
    setupEventListeners();
  });

  // ---- Load all data ----
  async function loadData() {
    allUsers = await Auth.getAllUsers();
    allPayments = await Auth.getAllPayments();
    renderStats();
    renderUsers(allUsers);
    renderPayments(allPayments);
    populateUserSelect();
  }

  // ---- Render Stats ----
  function renderStats() {
    document.getElementById("stat-total-users").textContent = allUsers.length;
    document.getElementById("stat-active-users").textContent = allUsers.filter(u => u.estado === 'activo').length;
    document.getElementById("stat-bot-users").textContent = allUsers.filter(u => u.bot_activo).length;
    const completedPayments = allPayments.filter(p => p.estado === 'completado');
    const revenue = completedPayments.reduce((sum, p) => sum + parseFloat(p.monto || 0), 0);
    document.getElementById("stat-revenue").textContent = '$' + revenue.toFixed(2);

    // Secondary stats
    document.getElementById("stat-fase1").textContent = allUsers.filter(u => u.fase === 'fase-1').length;
    document.getElementById("stat-ambas").textContent = allUsers.filter(u => u.fase === 'ambas').length;
    document.getElementById("stat-no-access").textContent = allUsers.filter(u => !u.fase).length;
    document.getElementById("stat-completed-payments").textContent = completedPayments.length;
    document.getElementById("stat-pending-payments").textContent = allPayments.filter(p => p.estado === 'pendiente').length;
    document.getElementById("stat-comunidad").textContent = allUsers.filter(u => u.comunidad_activa).length;
  }

  // ---- Render Users Table ----
  function renderUsers(users) {
    const tbody = document.getElementById("users-table-body");
    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="9" class="table-empty">No hay usuarios registrados</td></tr>';
      return;
    }

    tbody.innerHTML = users.map(u => {
      const statusClass = u.estado === 'activo' ? 'status-active' :
                          u.estado === 'suspendido' ? 'status-suspended' : 'status-inactive';
      const roleClass = u.rol === 'admin' ? 'role-admin' : 'role-student';
      const faseMap = { 'fase-1': 'Fase 1', 'fase-2': 'Fase 2', 'ambas': 'Ambas' };
      const faseText = faseMap[u.fase] || 'Sin acceso';
      const faseClass = u.fase ? '' : 'text-dim';
      const botClass = u.bot_activo ? 'status-bot-on' : 'status-bot-off';
      const botText = u.bot_activo ? 'Activo' : 'No';
      const comClass = u.comunidad_activa ? 'status-bot-on' : 'status-bot-off';
      const comText = u.comunidad_activa ? 'Si' : 'No';
      const fecha = u.fecha_registro ? new Date(u.fecha_registro).toLocaleDateString('es-AR') : '-';

      return '<tr>' +
        '<td><div class="user-cell"><div class="user-avatar-sm">' + (u.nombre || 'U').charAt(0).toUpperCase() + '</div><span>' + (u.nombre || 'Sin nombre') + '</span></div></td>' +
        '<td class="td-email">' + (u.email || '-') + '</td>' +
        '<td><span class="badge ' + roleClass + '">' + (u.rol || 'alumno') + '</span></td>' +
        '<td class="' + faseClass + '">' + faseText + '</td>' +
        '<td><span class="badge ' + botClass + '">' + botText + '</span></td>' +
        '<td><span class="badge ' + comClass + '">' + comText + '</span></td>' +
        '<td><span class="badge ' + statusClass + '">' + (u.estado || 'activo') + '</span></td>' +
        '<td class="td-date">' + fecha + '</td>' +
        '<td><button class="btn-edit" onclick="openEditUser(\'' + u.id + '\')">Editar</button></td>' +
      '</tr>';
    }).join('');
  }

  // ---- Render Payments Table ----
  function renderPayments(payments) {
    const tbody = document.getElementById("payments-table-body");
    if (!payments.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No hay pagos registrados</td></tr>';
      return;
    }

    tbody.innerHTML = payments.map(p => {
      const nombre = p.profiles?.nombre || 'Desconocido';
      const statusClass = p.estado === 'completado' ? 'status-active' :
                          p.estado === 'pendiente' ? 'status-pending' : 'status-suspended';
      const fecha = p.fecha ? new Date(p.fecha).toLocaleDateString('es-AR') : '-';

      return '<tr>' +
        '<td>' + nombre + '</td>' +
        '<td class="td-amount">$' + parseFloat(p.monto).toFixed(2) + ' ' + (p.moneda || 'USD') + '</td>' +
        '<td>' + (p.metodo || '-') + '</td>' +
        '<td>' + (p.concepto || '-') + '</td>' +
        '<td><span class="badge ' + statusClass + '">' + (p.estado || 'completado') + '</span></td>' +
        '<td class="td-date">' + fecha + '</td>' +
      '</tr>';
    }).join('');
  }

  // ---- Populate user selects ----
  function populateUserSelect() {
    const options = '<option value="">Seleccionar usuario...</option>' +
      allUsers.map(u => '<option value="' + u.id + '">' + (u.nombre || u.email) + '</option>').join('');
    document.getElementById("payment-user").innerHTML = options;
    document.getElementById("qa-access-user").innerHTML = options;
    document.getElementById("qa-bot-user").innerHTML = options;
    document.getElementById("qa-suspend-user").innerHTML = options;
    document.getElementById("qa-comunidad-user").innerHTML = options;

    // Notification select includes "all users" option
    const notifOptions = '<option value="all">Todos los usuarios</option>' +
      allUsers.map(u => '<option value="' + u.id + '">' + (u.nombre || u.email) + '</option>').join('');
    document.getElementById("qa-notif-user").innerHTML = notifOptions;
  }

  // ---- Setup Event Listeners ----
  function setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    // User search
    document.getElementById("user-search").addEventListener("input", filterUsers);
    document.getElementById("user-filter").addEventListener("change", filterUsers);

    // Logout
    document.getElementById("btn-logout").addEventListener("click", async () => {
      await Auth.logout();
      window.location.href = "iniciar-sesion.html";
    });

    // Add payment button
    document.getElementById("btn-add-payment").addEventListener("click", () => {
      openModal("modal-add-payment");
    });

    // Edit user form
    document.getElementById("form-edit-user").addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = document.getElementById("edit-user-id").value;
      const newFase = document.getElementById("edit-user-fase").value || null;
      const botActive = document.getElementById("edit-user-bot").checked;
      const comunidadActive = document.getElementById("edit-user-comunidad").checked;
      const updates = {
        nombre: document.getElementById("edit-user-name").value,
        rol: document.getElementById("edit-user-role").value,
        fase: newFase,
        estado: document.getElementById("edit-user-status").value,
        bot_activo: botActive,
        bot_licencia: botActive ? (document.getElementById("edit-user-license").value || null) : null,
        comunidad_activa: comunidadActive,
        notas: document.getElementById("edit-user-notes").value
      };

      // Check if phase is being assigned (was null, now has a value)
      const oldUser = allUsers.find(u => u.id === userId);
      const phaseAssigned = newFase && (!oldUser || !oldUser.fase);

      const result = await Auth.updateUser(userId, updates);
      if (result.success) {
        // Create progress entries when assigning phase for the first time
        if (phaseAssigned) {
          await Auth.initProgress(userId);
        }
        closeModal("modal-edit-user");
        showToast('Usuario actualizado correctamente');
        await loadData();
      } else {
        alert("Error: " + (result.error || "No se pudo actualizar"));
      }
    });

    // Bot toggle label + license field visibility
    document.getElementById("edit-user-bot").addEventListener("change", (e) => {
      document.getElementById("edit-bot-label").textContent = e.target.checked ? 'Activo' : 'Inactivo';
      document.getElementById("edit-license-field").style.display = e.target.checked ? 'block' : 'none';
    });

    // Community toggle label
    document.getElementById("edit-user-comunidad").addEventListener("change", (e) => {
      document.getElementById("edit-comunidad-label").textContent = e.target.checked ? 'Con acceso' : 'Sin acceso';
    });

    // Generate license button
    document.getElementById("btn-generate-license").addEventListener("click", () => {
      document.getElementById("edit-user-license").value = generateLicense();
    });

    // Payment filter
    document.getElementById("payment-filter").addEventListener("change", filterPayments);

    // Add payment form
    document.getElementById("form-add-payment").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payment = {
        user_id: document.getElementById("payment-user").value,
        monto: parseFloat(document.getElementById("payment-amount").value),
        moneda: document.getElementById("payment-currency").value,
        metodo: document.getElementById("payment-method").value,
        concepto: document.getElementById("payment-concept").value,
        estado: 'completado'
      };
      if (!payment.user_id || !payment.monto) {
        alert("Completa usuario y monto.");
        return;
      }
      const result = await Auth.addPayment(payment);
      if (result.success) {
        closeModal("modal-add-payment");
        document.getElementById("form-add-payment").reset();
        await loadData();
      } else {
        alert("Error: " + (result.error || "No se pudo registrar"));
      }
    });
  }

  // ---- Filter users ----
  function filterUsers() {
    const search = document.getElementById("user-search").value.toLowerCase();
    const filter = document.getElementById("user-filter").value;

    let filtered = allUsers;
    if (search) {
      filtered = filtered.filter(u =>
        (u.nombre || '').toLowerCase().includes(search) ||
        (u.email || '').toLowerCase().includes(search)
      );
    }
    if (filter !== 'all') {
      if (filter === 'admin') {
        filtered = filtered.filter(u => u.rol === 'admin');
      } else if (filter === 'bot') {
        filtered = filtered.filter(u => u.bot_activo);
      } else if (filter === 'fase-1') {
        filtered = filtered.filter(u => u.fase === 'fase-1' || u.fase === 'ambas');
      } else if (filter === 'ambas') {
        filtered = filtered.filter(u => u.fase === 'ambas');
      } else if (filter === 'sin-acceso') {
        filtered = filtered.filter(u => !u.fase);
      } else if (filter === 'comunidad') {
        filtered = filtered.filter(u => u.comunidad_activa);
      } else {
        filtered = filtered.filter(u => u.estado === filter);
      }
    }
    renderUsers(filtered);
  }

  // ---- Filter payments ----
  function filterPayments() {
    const filter = document.getElementById("payment-filter").value;
    let filtered = allPayments;
    if (filter !== 'all') {
      filtered = filtered.filter(p => p.estado === filter);
    }
    renderPayments(filtered);
  }

  // ---- Open edit user modal ----
  function openEditUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    document.getElementById("edit-user-id").value = user.id;
    document.getElementById("edit-user-name").value = user.nombre || '';
    document.getElementById("edit-user-role").value = user.rol || 'alumno';
    document.getElementById("edit-user-fase").value = user.fase || '';
    document.getElementById("edit-user-status").value = user.estado || 'activo';
    document.getElementById("edit-user-notes").value = user.notas || '';
    const botCheckbox = document.getElementById("edit-user-bot");
    botCheckbox.checked = !!user.bot_activo;
    document.getElementById("edit-bot-label").textContent = user.bot_activo ? 'Activo' : 'Inactivo';
    document.getElementById("edit-user-license").value = user.bot_licencia || '';
    document.getElementById("edit-license-field").style.display = user.bot_activo ? 'block' : 'none';
    const comunidadCheckbox = document.getElementById("edit-user-comunidad");
    comunidadCheckbox.checked = !!user.comunidad_activa;
    document.getElementById("edit-comunidad-label").textContent = user.comunidad_activa ? 'Con acceso' : 'Sin acceso';
    openModal("modal-edit-user");
  }

  // ---- Modal helpers ----
  function openModal(id) {
    document.getElementById(id).classList.add('active');
  }

  function closeModal(id) {
    document.getElementById(id).classList.remove('active');
  }

  // Close modal on overlay click
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
      e.target.classList.remove('active');
    }
  });

  // ---- Toast notifications ----
  function showToast(message, type) {
    type = type || 'success';
    const existing = document.querySelector('.admin-toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.className = 'admin-toast toast-' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    requestAnimationFrame(function() { toast.classList.add('show'); });
    setTimeout(function() {
      toast.classList.remove('show');
      setTimeout(function() { toast.remove(); }, 300);
    }, 3000);
  }

  // ---- Quick Actions ----
  document.addEventListener('DOMContentLoaded', function() {
    // Give course access
    document.getElementById('btn-qa-access').addEventListener('click', async function() {
      const userId = document.getElementById('qa-access-user').value;
      const fase = document.getElementById('qa-access-fase').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      const result = await Auth.updateUser(userId, { fase: fase });
      if (result.success) {
        await Auth.initProgress(userId);
        showToast('Acceso otorgado correctamente');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Activate bot + license
    document.getElementById('btn-qa-bot-on').addEventListener('click', async function() {
      const userId = document.getElementById('qa-bot-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      const license = document.getElementById('qa-bot-license').value || generateLicense();
      const result = await Auth.updateUser(userId, { bot_activo: true, bot_licencia: license });
      if (result.success) {
        showToast('Bot activado con licencia: ' + license);
        document.getElementById('qa-bot-license').value = '';
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Deactivate bot
    document.getElementById('btn-qa-bot-off').addEventListener('click', async function() {
      const userId = document.getElementById('qa-bot-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      const result = await Auth.updateUser(userId, { bot_activo: false, bot_licencia: null });
      if (result.success) {
        showToast('Bot desactivado y licencia removida');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Suspend user
    document.getElementById('btn-qa-suspend').addEventListener('click', async function() {
      const userId = document.getElementById('qa-suspend-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      if (!confirm('Seguro que quieres suspender a este usuario?')) return;
      const result = await Auth.updateUser(userId, { estado: 'suspendido' });
      if (result.success) {
        showToast('Usuario suspendido');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Reactivate user
    document.getElementById('btn-qa-reactivate').addEventListener('click', async function() {
      const userId = document.getElementById('qa-suspend-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      const result = await Auth.updateUser(userId, { estado: 'activo' });
      if (result.success) {
        showToast('Usuario reactivado');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Give community access
    document.getElementById('btn-qa-comunidad-on').addEventListener('click', async function() {
      var userId = document.getElementById('qa-comunidad-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      var result = await Auth.updateUser(userId, { comunidad_activa: true });
      if (result.success) {
        showToast('Acceso a comunidad otorgado');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Revoke community access
    document.getElementById('btn-qa-comunidad-off').addEventListener('click', async function() {
      var userId = document.getElementById('qa-comunidad-user').value;
      if (!userId) { showToast('Selecciona un usuario', 'error'); return; }
      var result = await Auth.updateUser(userId, { comunidad_activa: false });
      if (result.success) {
        showToast('Acceso a comunidad revocado');
        await loadData();
      } else {
        showToast('Error: ' + (result.error || 'No se pudo actualizar'), 'error');
      }
    });

    // Send notification
    document.getElementById('btn-qa-notif-send').addEventListener('click', async function() {
      var targetUser = document.getElementById('qa-notif-user').value;
      var titulo = document.getElementById('qa-notif-title').value.trim();
      var mensaje = document.getElementById('qa-notif-message').value.trim();
      var tipo = document.getElementById('qa-notif-type').value;

      if (!titulo || !mensaje) {
        showToast('Completa titulo y mensaje', 'error');
        return;
      }

      var result;
      if (targetUser === 'all') {
        var userIds = allUsers.map(function(u) { return u.id; });
        result = await Auth.sendBulkNotification(userIds, titulo, mensaje, tipo);
      } else {
        result = await Auth.sendNotification(targetUser, titulo, mensaje, tipo);
      }

      if (result.success) {
        var count = targetUser === 'all' ? allUsers.length : 1;
        showToast('Notificacion enviada a ' + count + ' usuario(s)');
        document.getElementById('qa-notif-title').value = '';
        document.getElementById('qa-notif-message').value = '';
      } else {
        showToast('Error: ' + (result.error || 'No se pudo enviar'), 'error');
      }
    });

    // Export users CSV
    document.getElementById('btn-export-users').addEventListener('click', function() {
      if (!allUsers.length) { showToast('No hay usuarios para exportar', 'error'); return; }
      const headers = ['Nombre', 'Email', 'Rol', 'Fase', 'Bot', 'Comunidad', 'Estado', 'Registro'];
      const rows = allUsers.map(function(u) {
        return [
          u.nombre || '', u.email || '', u.rol || 'alumno',
          u.fase || 'sin-acceso', u.bot_activo ? 'Si' : 'No',
          u.comunidad_activa ? 'Si' : 'No',
          u.estado || 'activo',
          u.fecha_registro ? new Date(u.fecha_registro).toLocaleDateString('es-AR') : ''
        ].map(function(v) { return '"' + String(v).replace(/"/g, '""') + '"'; }).join(',');
      });
      downloadCSV('usuarios.csv', [headers.join(',')].concat(rows).join('\n'));
      showToast('Usuarios exportados');
    });

    // Export payments CSV
    document.getElementById('btn-export-payments').addEventListener('click', function() {
      if (!allPayments.length) { showToast('No hay pagos para exportar', 'error'); return; }
      const headers = ['Usuario', 'Monto', 'Moneda', 'Metodo', 'Concepto', 'Estado', 'Fecha'];
      var rows = allPayments.map(function(p) {
        return [
          p.profiles ? p.profiles.nombre : '', p.monto || 0, p.moneda || 'USD',
          p.metodo || '', p.concepto || '', p.estado || '',
          p.fecha ? new Date(p.fecha).toLocaleDateString('es-AR') : ''
        ].map(function(v) { return '"' + String(v).replace(/"/g, '""') + '"'; }).join(',');
      });
      downloadCSV('pagos.csv', [headers.join(',')].concat(rows).join('\n'));
      showToast('Pagos exportados');
    });
  });

  // ---- Generate license key ----
  function generateLicense() {
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var parts = [];
    for (var p = 0; p < 3; p++) {
      var segment = '';
      for (var i = 0; i < 4; i++) {
        segment += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      parts.push(segment);
    }
    return 'GBOT-' + parts.join('-');
  }

  function downloadCSV(filename, content) {
    const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
  }
</script>

</body>
</html>
