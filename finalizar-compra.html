<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">

  <title>Pago Seguro | Orbita Capital</title>

  <link rel="icon" href="assets/img/branding/orbita-logo-symbol.png" type="image/png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/checkout.css">
  <link rel="stylesheet" href="assets/css/footer.css">

  <meta name="description" content="Pago seguro para acceder a la comunidad de trading de Orbita Capital.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Pago Seguro | Orbita Capital">
  <meta property="og:image" content="assets/img/branding/orbita-logo-horizontal.png">
  <meta name="theme-color" content="#0a0e17">
</head>
<body>

<!-- ============================================================
     TOP BAR
     ============================================================ -->
<header class="checkout-topbar">
  <div class="topbar-left">
    <img class="topbar-logo" src="assets/img/branding/orbita-logo-symbol.png" alt="Logo" width="36" height="36">
    <span class="topbar-brand">Orbita Capital</span>
    <span class="topbar-secure">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Pago seguro
    </span>
  </div>
  <a href="index.html" class="topbar-back">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Volver
  </a>
</header>

<!-- ============================================================
     MAIN CHECKOUT LAYOUT
     ============================================================ -->
<div class="checkout-wrapper">

  <!-- LEFT: Payment Methods -->
  <div class="checkout-main">

    <!-- Cart recovery banner (JS-controlled) -->
    <div id="cart-recovery-banner" style="display:none; background:linear-gradient(135deg,rgba(59,130,246,0.12),rgba(139,92,246,0.08)); border:1px solid rgba(59,130,246,0.3); border-radius:12px; padding:0.9rem 1.1rem; margin-bottom:1.2rem; align-items:center; gap:0.8rem;">
      <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" width="20" height="20" style="flex-shrink:0;"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
      <span style="flex:1;font-size:0.88rem;color:#c8d0df;">Ten&eacute;s un pago pendiente. <strong style="color:#e8edf5;">Continu&aacute; donde lo dejaste</strong> &mdash; tu selecci&oacute;n fue recuperada.</span>
      <button onclick="document.getElementById('cart-recovery-banner').style.display='none'" style="background:none;border:none;color:#5a6478;cursor:pointer;font-size:1.1rem;padding:0;line-height:1;" aria-label="Cerrar">&times;</button>
    </div>

    <!-- Steps + Heading -->
    <div>
      <div class="checkout-steps">
        <div class="step completed">
          <span class="step-number">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
          </span>
          <span>Elegir plan</span>
        </div>
        <div class="step-line done"></div>
        <div class="step active">
          <span class="step-number">2</span>
          <span>M&eacute;todo de pago</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <span class="step-number">3</span>
          <span>Confirmaci&oacute;n</span>
        </div>
      </div>
      <h1 class="checkout-title">Complet&aacute; tu pago</h1>
      <p class="checkout-subtitle">Eleg&iacute; c&oacute;mo pagar &middot; tu acceso se activa en minutos</p>
    </div>

    <!-- How it works (reemplaza el banner de "pagos manuales") -->
    <div class="how-it-works">
      <div class="hiw-item">
        <div class="hiw-num">1</div>
        <div class="hiw-text">
          <strong>Pag&aacute;</strong>
          <span>Con el m&eacute;todo que prefieras</span>
        </div>
      </div>
      <div class="hiw-sep">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
      <div class="hiw-item">
        <div class="hiw-num">2</div>
        <div class="hiw-text">
          <strong>Mand&aacute; el comprobante</strong>
          <span>Por Instagram DM</span>
        </div>
      </div>
      <div class="hiw-sep">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
      <div class="hiw-item">
        <div class="hiw-num hiw-num-success">3</div>
        <div class="hiw-text">
          <strong>Acced&eacute; en minutos</strong>
          <span>Confirmamos al instante</span>
        </div>
      </div>
    </div>

    <!-- Currency Toggle -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Moneda de pago
      </h2>
      <div class="currency-toggle" id="currency-toggle">
        <button class="currency-btn active" data-currency="ars" id="btn-ars">
          <span class="currency-flag">&#127462;&#127479;</span> Pesos (ARS)
        </button>
        <button class="currency-btn" data-currency="usd" id="btn-usd">
          <span class="currency-flag">&#127482;&#127480;</span> D&oacute;lares (USD)
        </button>
      </div>
    </div>

    <!-- Login required notice (JS-controlled) -->
    <div class="login-required" id="login-notice" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
      <p>Para pagar necesit&aacute;s <a href="iniciar-sesion.html">iniciar sesi&oacute;n</a>. Si no ten&eacute;s cuenta, <a href="iniciar-sesion.html">registrate gratis</a>.</p>
    </div>

    <!-- Already a student link (JS-controlled) -->
    <a href="iniciar-sesion.html" class="already-student-link" id="already-student-link" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
      Ya soy alumno &mdash; Iniciar sesi&oacute;n
    </a>

    <!-- Card Payments -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Pagar con tarjeta
      </h2>

      <div class="payment-methods">

        <!-- MercadoPago Embedded (ARS) -->
        <div class="payment-method" data-method="mercadopago" id="method-mp">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Tarjeta de cr&eacute;dito o d&eacute;bito</div>
              <div class="payment-method-desc">Visa, Mastercard, AMEX &mdash; en pesos argentinos</div>
            </div>
            <span class="payment-method-badge">Seguro</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">
              <div class="detail-note">
                Complet&aacute; los datos de tu tarjeta directamente ac&aacute;. Tu pago se procesa de forma segura a trav&eacute;s de MercadoPago.
              </div>
              <div id="mp-brick-container" class="embedded-form-container"></div>
              <div id="mp-error" class="payment-error-msg"></div>
              <div id="mp-success" class="payment-success-msg" style="display:none;"></div>
              <button class="fallback-toggle" id="mp-fallback-btn" type="button">
                Prefiero pagar en la p&aacute;gina de MercadoPago
              </button>
            </div>
          </div>
        </div>

        <!-- Stripe Embedded (USD) -->
        <div class="payment-method" data-method="stripe" id="method-stripe" style="display:none;">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon intl">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Tarjeta internacional</div>
              <div class="payment-method-desc">Visa, Mastercard, AMEX &mdash; en d&oacute;lares</div>
            </div>
            <span class="payment-method-badge">Seguro</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">
              <div class="detail-note">
                Complet&aacute; los datos de tu tarjeta directamente ac&aacute;. Tu pago se procesa de forma segura a trav&eacute;s de Stripe.
              </div>
              <div id="stripe-form-container" class="embedded-form-container">
                <div id="stripe-loading" class="payment-loading">
                  <span class="spinner"></span> Cargando formulario de pago...
                </div>
                <div id="stripe-payment-element"></div>
                <div id="stripe-error" class="payment-error-msg"></div>
                <button class="btn-confirm-pay stripe" id="btn-confirm-stripe" type="button" style="display:none;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                  Pagar <span id="stripe-confirm-price">USD 37,00</span>
                </button>
              </div>
              <button class="fallback-toggle" id="stripe-fallback-btn" type="button">
                Prefiero pagar en la p&aacute;gina de Stripe
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="payment-or">o con pago directo</div>

    <!-- Manual Payment Methods (reframed) -->
    <div>
      <h2 class="payment-section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Pago directo
        <span class="section-badge">Acceso en minutos</span>
      </h2>

      <div class="note-card">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
        <p>
          Hac&eacute; el pago con los datos de abajo y mand&aacute;nos el comprobante por Instagram. Te habilitamos el acceso en minutos.<br>
          Mensaje sugerido: <em id="nota-mensaje">"Hola, les env&iacute;o el pago de la Fase 1. Mi nombre es: [Tu nombre]"</em>
        </p>
      </div>

      <div class="payment-methods" style="margin-top: 0.75rem;">

        <!-- Transferencia bancaria -->
        <div class="payment-method" data-method="banco" id="method-banco">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11M8 14v3M12 14v3M16 14v3"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Transferencia bancaria</div>
              <div class="payment-method-desc">Banco Galicia (USD) o Mercado Pago (ARS)</div>
            </div>
            <span class="payment-method-badge">Argentina</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">&#127974; Banco Galicia &mdash; Cuenta en d&oacute;lares</div>
                <div class="detail-row">
                  <span class="detail-label">Alias</span>
                  <span class="detail-value">GINO.OSTOLAZA.GON</span>
                  <button class="copy-btn" data-copy-text="GINO.OSTOLAZA.GON" title="Copiar alias">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Titular</span>
                  <span class="detail-value">Gonzalez Gino Ostolaza</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CBU</span>
                  <span class="detail-value">0070100230004026120398</span>
                  <button class="copy-btn" data-copy-text="0070100230004026120398" title="Copiar CBU">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CUIT</span>
                  <span class="detail-value">20-48637004-2</span>
                </div>
              </div>

              <div class="payment-divider"></div>

              <div class="detail-block">
                <div class="detail-block-title">&#128153; Mercado Pago &mdash; Cuenta en pesos</div>
                <div class="detail-row">
                  <span class="detail-label">Alias</span>
                  <span class="detail-value">gino.ostolaza</span>
                  <button class="copy-btn" data-copy-text="gino.ostolaza" title="Copiar alias">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Titular</span>
                  <span class="detail-value">Gino Ostolaza Gonzalez</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CVU</span>
                  <span class="detail-value">0000003100052857370471</span>
                  <button class="copy-btn" data-copy-text="0000003100052857370471" title="Copiar CVU">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
                <div class="detail-row">
                  <span class="detail-label">CUIT</span>
                  <span class="detail-value">20-48637004-2</span>
                </div>
              </div>

              <div class="ars-conversion" id="conversion-banco">
                Equivalente en pesos: <strong class="resultado-transferencia">Cargando...</strong> ARS
              </div>

              <!-- Instagram confirmation CTA -->
              <div class="confirm-instagram-cta">
                <p class="confirm-cta-title">&iquest;Ya realizaste la transferencia?</p>
                <p class="confirm-cta-sub">Mand&aacute;nos el comprobante por DM y confirmamos tu acceso en minutos</p>
                <a href="https://instagram.com/orbitacapital.io" target="_blank" rel="noopener noreferrer" class="btn-instagram-confirm">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                  Enviar comprobante &mdash; @orbitacapital.io
                </a>
              </div>

            </div>
          </div>
        </div>

        <!-- Cripto -->
        <div class="payment-method" data-method="cripto" id="method-cripto">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon cripto">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.215-6.893m-1.215 6.893-6.083-1.072m6.083 1.072.347-1.971m-1.562 8.864-6.083-1.072m7.645-7.893L5.514 9.204m7.645 7.892 1.043-5.922M5.86 18.047l1.043-5.922m0 0-1.389-7.921"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">Criptomonedas</div>
              <div class="payment-method-desc">Bitcoin, Ethereum o USDT</div>
            </div>
            <span class="payment-method-badge">Global</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">Redes aceptadas</div>
                <div class="detail-row">
                  <span class="detail-label">Bitcoin</span>
                  <span class="detail-value">BTC Network</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Ethereum</span>
                  <span class="detail-value">ERC-20</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">USDT</span>
                  <span class="detail-value">TRC-20 / ERC-20</span>
                </div>
              </div>

              <!-- Instagram CTA: wallet request -->
              <div class="confirm-instagram-cta">
                <p class="confirm-cta-title">Ped&iacute; la wallet por Instagram</p>
                <p class="confirm-cta-sub">Por seguridad compartimos las direcciones exclusivamente por DM</p>
                <a href="https://instagram.com/orbitacapital.io" target="_blank" rel="noopener noreferrer" class="btn-instagram-confirm">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                  Escribir a @orbitacapital.io
                </a>
              </div>

            </div>
          </div>
        </div>

        <!-- Internacional (PayPal / Skrill) -->
        <div class="payment-method" data-method="intl" id="method-intl">
          <div class="payment-method-header">
            <div class="payment-radio"><div class="payment-radio-inner"></div></div>
            <div class="payment-method-icon intl">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            </div>
            <div class="payment-method-info">
              <div class="payment-method-name">PayPal / Skrill (USD)</div>
              <div class="payment-method-desc">Pago internacional</div>
            </div>
            <span class="payment-method-badge">Internacional</span>
          </div>
          <div class="payment-details">
            <div class="payment-details-inner">

              <div class="detail-block">
                <div class="detail-block-title">PayPal</div>
                <div class="detail-row">
                  <span class="detail-label">Link de pago</span>
                  <a href="https://paypal.me/GinoOstolaza/" target="_blank" rel="noopener noreferrer" class="detail-link">paypal.me/GinoOstolaza</a>
                </div>
                <p style="font-size:0.8rem;color:var(--color-text-dim);margin-top:0.3rem;">Coloc&aacute; tu nombre completo en las notas del pago.</p>
              </div>

              <div class="payment-divider"></div>

              <div class="detail-block">
                <div class="detail-block-title">Skrill</div>
                <div class="detail-row">
                  <span class="detail-label">Email</span>
                  <span class="detail-value">ginitoostolaza1@gmail.com</span>
                  <button class="copy-btn" data-copy-text="ginitoostolaza1@gmail.com" title="Copiar email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                </div>
                <p style="font-size:0.8rem;color:var(--color-text-dim);margin-top:0.3rem;">Indic&aacute; tu nombre completo en el campo de mensaje.</p>
              </div>

              <!-- Instagram CTA -->
              <div class="confirm-instagram-cta">
                <p class="confirm-cta-title">&iquest;Ya realizaste el pago?</p>
                <p class="confirm-cta-sub">Avis&aacute;nos por Instagram con tu nombre y el comprobante</p>
                <a href="https://instagram.com/orbitacapital.io" target="_blank" rel="noopener noreferrer" class="btn-instagram-confirm">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                  Confirmar pago &mdash; @orbitacapital.io
                </a>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Trust badges -->
    <div class="trust-badges">
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        SSL 256-bit
      </div>
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Stripe &amp; MercadoPago
      </div>
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
        Acceso inmediato
      </div>
      <div class="trust-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Respuesta &lt; 10 min
      </div>
    </div>

  </div>

  <!-- RIGHT: Order Summary Sidebar -->
  <aside class="checkout-sidebar">

    <div class="order-summary">
      <h2 class="summary-title">Resumen del pedido</h2>

      <div class="summary-product" id="summary-product">
        <div class="summary-product-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </div>
        <div class="summary-product-info">
          <div class="summary-product-name" id="summary-name">Fase 1 &mdash; Comunidad de Trading</div>
          <div class="summary-product-desc" id="summary-desc">Acceso completo al curso + comunidad</div>
        </div>
      </div>

      <div class="summary-row">
        <span class="summary-label">Subtotal</span>
        <span class="summary-value" id="summary-subtotal">$47.000 ARS</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Comisi&oacute;n</span>
        <span class="summary-value" style="color: var(--color-success);">$0,00</span>
      </div>

      <div class="summary-divider"></div>

      <div class="summary-total">
        <span class="summary-total-label">Total</span>
        <span class="summary-total-value" id="summary-total">$47.000 ARS</span>
      </div>

      <div class="summary-divider"></div>

      <ul class="summary-benefits" id="summary-benefits">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          2 sistemas de trading probados
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Desarrollo personal y psicotrading
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Acceso a comunidad exclusiva
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Acceso se habilita al instante
        </li>
      </ul>
    </div>

    <!-- Social proof testimonial -->
    <div class="testimonial-card">
      <div class="testimonial-stars">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
      <p>"En mi primera semana ya recuper&eacute; lo que pagu&eacute;. El soporte es incre&iacute;ble, te responden en minutos."</p>
      <span>&mdash; Mat&iacute;as R., alumno activo de Fase 1</span>
    </div>

    <!-- Dolar Blue -->
    <div class="dolar-card">
      <div class="dolar-card-title">Cotizaci&oacute;n de referencia</div>
      <div class="dolar-card-value" id="dolar-blue">Consultando d&oacute;lar blue...</div>
      <div class="dolar-card-note">Referencia: d&oacute;lar blue (venta)</div>
    </div>

    <!-- Contact card -->
    <div class="contact-card">
      <p>&iquest;Ya pagaste o ten&eacute;s dudas? Escrib&iacute;nos y te ayudamos en minutos.</p>
      <a href="https://instagram.com/orbitacapital.io" target="_blank" rel="noopener noreferrer" class="contact-link">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        Escribir por Instagram &rarr;
      </a>
    </div>

    <!-- Login -->
    <a href="iniciar-sesion.html" class="login-link" id="sidebar-login">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
      Ya soy alumno &mdash; Iniciar sesi&oacute;n
    </a>

  </aside>
</div>

<div id="footer"></div>
<script src="assets/js/footer.js"></script>

<!-- Payment SDKs -->
<script src="https://js.stripe.com/v3/"></script>
<script src="https://sdk.mercadopago.com/js/v2"></script>

<!-- Supabase (to check login state) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js"></script>
<script src="assets/js/auth.js"></script>

<!-- Copy to clipboard -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var text = btn.dataset.copyText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(function() {
          var origHTML = btn.innerHTML;
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><path d="M20 6L9 17l-5-5"/></svg>';
          btn.classList.add('copied');
          setTimeout(function() { btn.innerHTML = origHTML; btn.classList.remove('copied'); }, 1500);
        }).catch(function() {});
      });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    // --- Cart abandonment: check & save state ---
    (function() {
      var CART_KEY = 'oc_cart_state';
      var saved = null;
      try { saved = JSON.parse(localStorage.getItem(CART_KEY)); } catch(e) {}
      if (saved && saved.timestamp && (Date.now() - saved.timestamp) < 48 * 3600 * 1000) {
        var banner = document.getElementById('cart-recovery-banner');
        if (banner) banner.style.display = 'flex';
        // Restore currency if saved
        if (saved.currency === 'usd') {
          var btnArs = document.getElementById('btn-ars');
          var btnUsd = document.getElementById('btn-usd');
          if (btnArs) btnArs.classList.remove('active');
          if (btnUsd) btnUsd.classList.add('active');
        }
      }
      // Save current visit to localStorage
      var params = new URLSearchParams(window.location.search);
      var cartState = { plan: params.get('plan') || 'fase1', currency: 'ars', timestamp: Date.now() };
      localStorage.setItem(CART_KEY, JSON.stringify(cartState));
    })();

    // --- Detect plan from URL ---
    const params = new URLSearchParams(window.location.search);
    const plan = params.get('plan') || 'fase1';
    const isBot = plan === 'bot';

    // --- Pricing (defaults, overridden by Supabase config) ---
    const PRICES = {
      fase1: { ars: 47000, usd: 37 },
      bot:   { ars: 24900, usd: 24 }
    };
    // Load dynamic prices from Supabase
    var siteConfig = await Auth.getSiteConfig();
    if (siteConfig.prices) {
      var p = siteConfig.prices;
      PRICES.fase1.ars = p.fase1_ars || PRICES.fase1.ars;
      PRICES.fase1.usd = p.fase1_usd || PRICES.fase1.usd;
      PRICES.bot.ars = p.bot_ars || PRICES.bot.ars;
      PRICES.bot.usd = p.bot_usd || PRICES.bot.usd;
    }
    const prices = PRICES[plan] || PRICES.fase1;
    let currentCurrency = 'ars';
    // Auto-detect currency: non-Argentine users → USD
    (function() {
      var lang = (navigator.language || navigator.userLanguage || 'es').toLowerCase();
      if (!lang.startsWith('es-ar') && !lang.startsWith('es_ar')) {
        currentCurrency = 'usd';
        var btnArs = document.getElementById('btn-ars');
        var btnUsd = document.getElementById('btn-usd');
        if (btnArs) btnArs.classList.remove('active');
        if (btnUsd) btnUsd.classList.add('active');
      }
    })();

    // --- Payment SDK state ---
    let paymentKeys = { stripe_publishable_key: '', mercadopago_public_key: '' };
    let stripeInstance = null;
    let stripeElements = null;
    let stripeIntentCreated = false;
    let mpBrickMounted = false;
    let mpInstance = null;

    // --- Check if user is logged in ---
    Auth.init();
    let userData = null;
    const storedUser = localStorage.getItem('usuario');
    const isLoggedIn = localStorage.getItem('accesoAutorizado') === 'true' && storedUser;

    if (isLoggedIn) {
      userData = JSON.parse(storedUser);
      document.getElementById('login-notice').style.display = 'none';
      document.getElementById('sidebar-login').style.display = 'none';
      document.getElementById('already-student-link').style.display = 'none';
    } else {
      document.getElementById('login-notice').style.display = 'flex';
      document.getElementById('already-student-link').style.display = 'flex';
    }

    // --- Fetch payment config (public keys) ---
    try {
      const configRes = await fetch('/api/payment-config');
      if (configRes.ok) {
        paymentKeys = await configRes.json();
      }
    } catch (e) {
      console.warn('Could not fetch payment config:', e);
    }

    // --- Update product info based on plan ---
    if (isBot) {
      document.getElementById('summary-name').textContent = 'Bot de Trading — Suscripcion Mensual';
      document.getElementById('summary-desc').textContent = 'Bot automatizado configurado por Orbita Capital';
      document.getElementById('nota-mensaje').textContent =
        '"Hola, les envio el pago del Bot de Trading. Mi nombre es: [Tu nombre]"';
      document.title = 'Bot de Trading | Pago Seguro';

      document.querySelector('.summary-product-icon').innerHTML =
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.07A7 7 0 0 1 14 23h-4a7 7 0 0 1-6.93-4H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="16" r="1" fill="currentColor"/><circle cx="15" cy="16" r="1" fill="currentColor"/></svg>';

      const benefits = document.getElementById('summary-benefits');
      benefits.innerHTML =
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Opera automaticamente 24/7</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Configurado por nuestro equipo</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Actualizaciones incluidas</li>' +
        '<li><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>Acceso se habilita al instante</li>';
    }

    // --- Format helpers ---
    function fmtARS(n) { return '$' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ARS'; }
    function fmtUSD(n) { return 'USD ' + n.toFixed(2).replace('.', ','); }

    // --- Update displayed prices ---
    function updatePrices() {
      const isARS = currentCurrency === 'ars';
      const priceStr = isARS ? fmtARS(prices.ars) : fmtUSD(prices.usd);

      document.getElementById('summary-subtotal').textContent = priceStr;
      document.getElementById('summary-total').textContent = priceStr;

      const confirmPrice = document.getElementById('stripe-confirm-price');
      if (confirmPrice) confirmPrice.textContent = fmtUSD(prices.usd);

      // Show/hide payment methods based on currency
      document.getElementById('method-mp').style.display = isARS ? 'block' : 'none';
      document.getElementById('method-stripe').style.display = isARS ? 'none' : 'block';

      // Deselect current method when currency changes
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
    }

    // --- Currency toggle ---
    document.querySelectorAll('.currency-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCurrency = btn.dataset.currency;
        updatePrices();
      });
    });

    // Initial price update
    updatePrices();

    // --- Payment method selection ---
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', (e) => {
        // Don't toggle if clicking inside form, buttons, or Instagram CTAs
        if (e.target.closest('.embedded-form-container') ||
            e.target.closest('.btn-confirm-pay') ||
            e.target.closest('.fallback-toggle') ||
            e.target.closest('.copy-btn') ||
            e.target.closest('.btn-instagram-confirm')) return;

        const wasSelected = method.classList.contains('selected');
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));

        if (!wasSelected) {
          method.classList.add('selected');
          const methodType = method.dataset.method;

          // Initialize embedded forms on first selection
          if (methodType === 'stripe' && !stripeIntentCreated && isLoggedIn) {
            initStripeEmbed();
          }
          if (methodType === 'mercadopago' && !mpBrickMounted && isLoggedIn) {
            initMPBrick();
          }
        }
      });
    });

    // ============================================================
    // STRIPE EMBEDDED PAYMENT ELEMENT
    // ============================================================
    async function initStripeEmbed() {
      if (!paymentKeys.stripe_publishable_key) {
        showError('stripe-error', 'Configuracion de Stripe no disponible. Usa el metodo alternativo.');
        return;
      }
      if (!isLoggedIn) {
        showError('stripe-error', 'Necesitas iniciar sesion para pagar.');
        return;
      }

      const loadingEl = document.getElementById('stripe-loading');
      const confirmBtn = document.getElementById('btn-confirm-stripe');

      try {
        // Create PaymentIntent
        const res = await fetch('/api/stripe-create-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: plan,
            user_id: userData.id,
            user_email: userData.email,
            user_nombre: userData.nombre
          })
        });

        const data = await res.json();
        if (!data.clientSecret) throw new Error(data.error || 'Error al crear intent');

        // Initialize Stripe
        stripeInstance = Stripe(paymentKeys.stripe_publishable_key);
        stripeElements = stripeInstance.elements({
          clientSecret: data.clientSecret,
          appearance: {
            theme: 'night',
            variables: {
              colorPrimary: '#635bff',
              colorBackground: '#0a0e17',
              colorText: '#e8edf5',
              colorTextSecondary: '#8b95a8',
              colorDanger: '#ef4444',
              fontFamily: 'Poppins, system-ui, sans-serif',
              borderRadius: '8px',
              spacingUnit: '4px'
            },
            rules: {
              '.Input': {
                border: '1px solid rgba(255, 255, 255, 0.1)',
                backgroundColor: '#131a2b',
                color: '#e8edf5',
                padding: '12px'
              },
              '.Input:focus': {
                border: '1px solid #635bff',
                boxShadow: '0 0 0 1px #635bff'
              },
              '.Label': {
                color: '#8b95a8',
                fontWeight: '500'
              }
            }
          }
        });

        // Mount Payment Element
        const paymentElement = stripeElements.create('payment', {
          layout: 'tabs'
        });
        paymentElement.mount('#stripe-payment-element');

        paymentElement.on('ready', () => {
          loadingEl.style.display = 'none';
          confirmBtn.style.display = 'flex';
          confirmBtn.disabled = false;
          stripeIntentCreated = true;
        });

        paymentElement.on('change', (event) => {
          if (event.error) {
            showError('stripe-error', event.error.message);
          } else {
            hideError('stripe-error');
          }
        });

      } catch (err) {
        console.error('Stripe embed init error:', err);
        loadingEl.innerHTML = 'No se pudo cargar el formulario. Usa el metodo alternativo.';
      }
    }

    // Stripe confirm payment
    const confirmStripeBtn = document.getElementById('btn-confirm-stripe');
    if (confirmStripeBtn) {
      confirmStripeBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!stripeInstance || !stripeElements) return;

        confirmStripeBtn.disabled = true;
        confirmStripeBtn.innerHTML = '<span class="spinner"></span> Procesando pago...';
        hideError('stripe-error');

        const siteUrl = window.location.origin;
        const returnUrl = siteUrl + '/pago-resultado.html?status=success&provider=stripe&producto=' + plan;

        const { error } = await stripeInstance.confirmPayment({
          elements: stripeElements,
          confirmParams: {
            return_url: returnUrl
          }
        });

        if (error) {
          showError('stripe-error', error.message);
          confirmStripeBtn.disabled = false;
          confirmStripeBtn.innerHTML =
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Pagar ' + fmtUSD(prices.usd);
        }
        // If no error, Stripe redirects automatically
      });
    }

    // Stripe fallback (redirect to hosted checkout)
    const stripeFallbackBtn = document.getElementById('stripe-fallback-btn');
    if (stripeFallbackBtn) {
      stripeFallbackBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!isLoggedIn) {
          window.location.href = 'iniciar-sesion.html';
          return;
        }

        stripeFallbackBtn.disabled = true;
        stripeFallbackBtn.textContent = 'Redirigiendo...';
        hideError('stripe-error');

        try {
          const response = await fetch('/api/stripe-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              producto_id: plan,
              user_id: userData.id,
              user_email: userData.email,
              user_nombre: userData.nombre
            })
          });
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error(data.error || 'Error');
          }
        } catch (err) {
          showError('stripe-error', 'Error al redirigir. Intenta de nuevo.');
          stripeFallbackBtn.disabled = false;
          stripeFallbackBtn.textContent = 'Prefiero pagar en la pagina de Stripe';
        }
      });
    }

    // ============================================================
    // MERCADOPAGO CHECKOUT BRICKS
    // ============================================================
    async function initMPBrick() {
      if (!paymentKeys.mercadopago_public_key) {
        showError('mp-error', 'Configuracion de MercadoPago no disponible. Usa el metodo alternativo.');
        return;
      }
      if (!isLoggedIn) {
        showError('mp-error', 'Necesitas iniciar sesion para pagar.');
        return;
      }

      const container = document.getElementById('mp-brick-container');
      container.innerHTML = '<div class="payment-loading"><span class="spinner"></span> Cargando formulario de pago...</div>';

      try {
        mpInstance = new MercadoPago(paymentKeys.mercadopago_public_key, {
          locale: 'es-AR'
        });

        const bricksBuilder = mpInstance.bricks();

        await bricksBuilder.create('cardPayment', 'mp-brick-container', {
          initialization: {
            amount: prices.ars
          },
          customization: {
            visual: {
              style: {
                theme: 'dark',
                customVariables: {
                  formBackgroundColor: '#0a0e17',
                  baseColor: '#3b82f6'
                }
              }
            },
            paymentMethods: {
              maxInstallments: 12
            }
          },
          callbacks: {
            onReady: () => {
              mpBrickMounted = true;
            },
            onSubmit: async (cardFormData) => {
              hideError('mp-error');
              try {
                const response = await fetch('/api/mercadopago-process', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    ...cardFormData,
                    transaction_amount: prices.ars,
                    producto_id: plan,
                    user_id: userData.id
                  })
                });

                const result = await response.json();

                if (result.status === 'approved') {
                  window.location.href = 'pago-resultado.html?status=success&provider=mercadopago&producto=' + plan + '&payment_id=' + result.id;
                } else if (result.status === 'in_process' || result.status === 'pending') {
                  window.location.href = 'pago-resultado.html?status=pending&provider=mercadopago&producto=' + plan;
                } else {
                  const msg = getMPErrorMessage(result.status_detail);
                  showError('mp-error', msg);
                }
              } catch (err) {
                console.error('MP process error:', err);
                showError('mp-error', 'Error al procesar el pago. Intenta de nuevo.');
              }
            },
            onError: (error) => {
              console.error('MP Brick error:', error);
            }
          }
        });

      } catch (err) {
        console.error('MP Brick init error:', err);
        container.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--color-text-muted);font-size:0.85rem;">No se pudo cargar el formulario. Usa el metodo alternativo.</div>';
      }
    }

    // MercadoPago error messages
    function getMPErrorMessage(statusDetail) {
      const messages = {
        'cc_rejected_bad_filled_card_number': 'Revisa el numero de tarjeta.',
        'cc_rejected_bad_filled_date': 'Revisa la fecha de vencimiento.',
        'cc_rejected_bad_filled_other': 'Revisa los datos ingresados.',
        'cc_rejected_bad_filled_security_code': 'Revisa el codigo de seguridad.',
        'cc_rejected_blacklist': 'No pudimos procesar tu pago. Usa otra tarjeta.',
        'cc_rejected_call_for_authorize': 'Debes autorizar el pago con tu banco.',
        'cc_rejected_card_disabled': 'Tu tarjeta esta deshabilitada. Contacta a tu banco.',
        'cc_rejected_duplicated_payment': 'Ya realizaste un pago con este monto. Si necesitas volver a pagar, espera unos minutos.',
        'cc_rejected_high_risk': 'Tu pago fue rechazado. Usa otra tarjeta.',
        'cc_rejected_insufficient_amount': 'Fondos insuficientes.',
        'cc_rejected_invalid_installments': 'Tu tarjeta no acepta esta cantidad de cuotas.',
        'cc_rejected_max_attempts': 'Llegaste al limite de intentos. Usa otra tarjeta.',
        'cc_rejected_other_reason': 'Tu pago fue rechazado. Intenta con otra tarjeta o usa otro metodo.'
      };
      return messages[statusDetail] || 'El pago fue rechazado. Intenta con otra tarjeta o usa otro metodo.';
    }

    // MercadoPago fallback (redirect to Checkout Pro)
    const mpFallbackBtn = document.getElementById('mp-fallback-btn');
    if (mpFallbackBtn) {
      mpFallbackBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!isLoggedIn) {
          window.location.href = 'iniciar-sesion.html';
          return;
        }

        mpFallbackBtn.disabled = true;
        mpFallbackBtn.textContent = 'Redirigiendo...';
        hideError('mp-error');

        try {
          const response = await fetch('/api/mercadopago-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              producto_id: plan,
              user_id: userData.id,
              user_email: userData.email,
              user_nombre: userData.nombre
            })
          });
          const data = await response.json();
          if (data.init_point) {
            window.location.href = data.init_point;
          } else {
            throw new Error(data.error || 'Error');
          }
        } catch (err) {
          showError('mp-error', 'Error al redirigir. Intenta de nuevo.');
          mpFallbackBtn.disabled = false;
          mpFallbackBtn.textContent = 'Prefiero pagar en la pagina de MercadoPago';
        }
      });
    }

    // ============================================================
    // HELPERS
    // ============================================================
    function showError(id, msg) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
        el.classList.add('visible');
        el.style.display = 'block';
      }
    }

    function hideError(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove('visible');
        el.style.display = 'none';
      }
    }

    // --- Dolar Blue API ---
    fetch("https://api.bluelytics.com.ar/v2/latest")
      .then(r => r.json())
      .then(data => {
        const dolarBlue = data.blue.value_sell;

        const dolarEl = document.getElementById("dolar-blue");
        if (dolarEl) {
          dolarEl.textContent = '$' + dolarBlue.toFixed(2) + ' ARS';
        }

        // Show ARS equivalent for bank transfer
        const resultado = prices.usd * dolarBlue;
        const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        document.querySelectorAll(".resultado-transferencia").forEach(span => {
          span.textContent = '$' + fmt(Math.round(resultado));
        });
      })
      .catch(() => {
        const dolarEl = document.getElementById("dolar-blue");
        if (dolarEl) dolarEl.textContent = "No disponible";
      });

    // --- Tab title ---
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        document.title = "Completar pago";
      } else {
        document.title = isBot ? "Bot de Trading | Pago Seguro" : "Pago Seguro | Orbita Capital";
      }
    });
  });
</script>

</body>
</html>
