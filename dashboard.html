<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Dashboard | Binary Edge Academy</title>

  <!-- Auth guard (quick check) -->
  <script>
    (function () {
      var acceso = sessionStorage.getItem("accesoAutorizado");
      if (!acceso || acceso !== "true") {
        window.location.replace("iniciar-sesion.html");
      }
    })();
  </script>

  <link rel="icon" href="assets/img/branding/logo-favicon.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css">
  <meta name="theme-color" content="#0a0e17">
</head>
<body>

<!-- ============================================================
     TOP NAVIGATION
     ============================================================ -->
<nav class="dash-nav">
  <div class="dash-nav-left">
    <img class="dash-nav-logo" src="assets/img/branding/logo-favicon.png" alt="Logo" width="32" height="32">
    <span class="dash-nav-brand">Binary Edge</span>
    <span class="dash-nav-tag" id="user-role-tag">Alumno</span>
  </div>
  <div class="dash-nav-right">
    <a href="admin.html" class="btn-admin" id="btn-admin" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      <span>Panel Admin</span>
    </a>
    <!-- Notification Bell -->
    <div class="notif-wrapper" id="notif-wrapper">
      <button class="notif-bell" id="notif-bell" title="Notificaciones">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <span class="notif-badge" id="notif-badge" style="display:none;">0</span>
      </button>
      <div class="notif-dropdown" id="notif-dropdown">
        <div class="notif-dropdown-header">
          <h4>Notificaciones</h4>
          <button class="notif-mark-all" id="notif-mark-all" title="Marcar todas como leidas">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
          </button>
        </div>
        <div class="notif-list" id="notif-list">
          <div class="notif-empty">No tienes notificaciones</div>
        </div>
      </div>
    </div>
    <div class="dash-nav-user">
      <div class="user-avatar" id="user-avatar">U</div>
      <span id="user-name-nav">Usuario</span>
    </div>
    <button class="btn-logout" id="btn-logout">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      Salir
    </button>
  </div>
</nav>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<div class="dash-container">

  <!-- Welcome -->
  <div class="dash-welcome">
    <div class="welcome-row">
      <div class="welcome-text">
        <h1>Bienvenido, <span id="user-name">Usuario</span></h1>
        <p id="welcome-subtitle">Tu centro de aprendizaje y crecimiento en trading</p>
      </div>
      <div class="welcome-date" id="welcome-date">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="dash-stats">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </div>
      <div class="stat-value">2</div>
      <div class="stat-label">Sistemas disponibles</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
      </div>
      <div class="stat-value" id="stat-status">Activo</div>
      <div class="stat-label">Estado de tu cuenta</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </div>
      <div class="stat-value" id="stat-fase">Fase 1</div>
      <div class="stat-label">Tu nivel actual</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon cyan">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      </div>
      <div class="stat-value">24/7</div>
      <div class="stat-label">Acceso al contenido</div>
    </div>
  </div>

  <!-- Progress Section -->
  <h2 class="section-title" id="progress-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    Tu progreso
  </h2>

  <div class="progress-section" id="progress-section">
    <div class="progress-header">
      <div class="progress-stats">
        <span class="progress-completed" id="progress-count">0 / 5</span>
        <span class="progress-label">modulos completados</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
      </div>
    </div>
    <div class="progress-modules" id="progress-modules">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- Course Cards -->
  <h2 class="section-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
    Tu contenido
  </h2>

  <div class="dash-grid">
    <!-- Curso de Trading (dynamic: locked/unlocked by JS) -->
    <div class="course-card card-blue" id="card-fase1">
      <div class="card-header">
        <div class="card-icon blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </div>
        <span class="card-badge" id="badge-fase1">-</span>
      </div>
      <h3 class="card-title">Curso de Trading — Fase 1</h3>
      <p class="card-desc">2 sistemas de trading probados, preparacion del grafico paso a paso, gestion de riesgo, psicologia del trader, glosario y consejos avanzados.</p>
      <ul class="card-features">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          2 sistemas de trading efectivos
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Preparacion del grafico paso a paso
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Consejos, glosario y errores a evitar
        </li>
      </ul>
      <div id="action-fase1"><!-- Filled by JS --></div>
    </div>

    <!-- Mentoria -->
    <div class="course-card card-purple">
      <div class="card-header">
        <div class="card-icon purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
        </div>
        <span class="card-badge badge-soon">Proximamente</span>
      </div>
      <h3 class="card-title">Mentoria Personalizada</h3>
      <p class="card-desc">Sesiones 1 a 1 con nuestro equipo para resolver dudas, revisar operaciones y potenciar tu crecimiento como trader.</p>
      <ul class="card-features">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Revision de operaciones en vivo
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Feedback personalizado
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Psicotrading y desarrollo personal
        </li>
      </ul>
      <span class="card-action action-disabled">Disponible pronto</span>
    </div>

    <!-- Comunidad (dynamic: active/locked by JS) -->
    <div class="course-card card-green" id="card-comunidad">
      <div class="card-header">
        <div class="card-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <span class="card-badge" id="badge-comunidad">-</span>
      </div>
      <h3 class="card-title">Comunidad Privada</h3>
      <p class="card-desc">Conecta con otros traders, comparte analisis, resultados y crece en un entorno motivador y de alto nivel.</p>
      <ul class="card-features">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Grupo exclusivo de alumnos
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Analisis compartidos
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Soporte entre pares
        </li>
      </ul>
      <div id="action-comunidad"><!-- Filled by JS --></div>
    </div>

    <!-- Bot de Trading (dynamic: active/locked by JS) -->
    <div class="course-card card-cyan" id="card-bot">
      <div class="card-header">
        <div class="card-icon cyan">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1.07A7 7 0 0 1 14 23h-4a7 7 0 0 1-6.93-4H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/></svg>
        </div>
        <span class="card-badge" id="badge-bot">Nuevo</span>
      </div>
      <h3 class="card-title">Bot de Trading</h3>
      <p class="card-desc">Bot automatizado configurado por nuestro equipo, opera 24/7 por vos. Solo conectalo y dejalo trabajar.</p>
      <ul class="card-features">
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Operacion automatica 24/7
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Actualizaciones incluidas
        </li>
        <li>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
          Soporte de instalacion
        </li>
      </ul>
      <div id="action-bot"><!-- Filled by JS --></div>
    </div>
  </div>

  <!-- Quick Links -->
  <h2 class="section-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
    Accesos rapidos
  </h2>

  <div class="quick-links">
    <a href="https://instagram.com/ginoostolaza_" target="_blank" rel="noopener noreferrer" class="quick-link">
      <div class="quick-link-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
      </div>
      <div>
        <div class="quick-link-text">Contactar soporte</div>
        <div class="quick-link-sub">Instagram directo</div>
      </div>
    </a>

    <a href="acceso-comunidad.html#glosario" class="quick-link">
      <div class="quick-link-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      </div>
      <div>
        <div class="quick-link-text">Glosario de Trading</div>
        <div class="quick-link-sub">Terminos esenciales</div>
      </div>
    </a>

    <a href="index.html" class="quick-link">
      <div class="quick-link-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <div>
        <div class="quick-link-text">Pagina principal</div>
        <div class="quick-link-sub">Volver al inicio</div>
      </div>
    </a>
  </div>

</div>

<!-- Supabase Auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/js/supabase-config.js"></script>
<script src="assets/js/auth.js"></script>

<script>
  const MODULE_NAMES = {
    'preparacion-grafico': 'Preparacion del Grafico',
    'flexzone': 'Sistema Flexzone',
    'relleno-zona': 'Sistema Relleno de Zona',
    'glosario': 'Glosario de Trading',
    'consejos': 'Consejos y Errores a Evitar'
  };

  document.addEventListener("DOMContentLoaded", async () => {
    Auth.init();
    await Auth.guard();

    const userData = JSON.parse(sessionStorage.getItem("usuario") || "{}");
    const nombre = userData.nombre || "Usuario";
    const inicial = nombre.charAt(0).toUpperCase();

    // --- User info ---
    document.getElementById("user-name").textContent = nombre;
    document.getElementById("user-name-nav").textContent = nombre;
    document.getElementById("user-avatar").textContent = inicial;

    // --- Role tag ---
    const roleTag = document.getElementById("user-role-tag");
    if (userData.rol === 'admin') {
      roleTag.textContent = 'Admin';
      roleTag.classList.add('tag-admin');
      document.getElementById("btn-admin").style.display = 'inline-flex';
    }

    // --- Status ---
    const statusEl = document.getElementById("stat-status");
    const estado = userData.estado || 'activo';
    statusEl.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
    if (estado === 'suspendido') statusEl.style.color = '#ef4444';

    // --- Phase ---
    const faseMap = { 'fase-1': 'Fase 1', 'fase-2': 'Fase 2', 'ambas': 'Fase 1 + 2' };
    const faseEl = document.getElementById("stat-fase");
    faseEl.textContent = faseMap[userData.fase] || 'Sin acceso';
    if (!userData.fase) faseEl.style.color = 'var(--color-text-dim)';

    // --- Date ---
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = now.toLocaleDateString('es-AR', options);
    document.getElementById("welcome-date").insertAdjacentText('beforeend', dateStr.charAt(0).toUpperCase() + dateStr.slice(1));

    // --- Fase 1 card (locked/unlocked) ---
    renderFase1Card(userData);

    // --- Bot card (active/locked) ---
    renderBotCard(userData);

    // --- Comunidad card (active/locked) ---
    renderComunidadCard(userData);

    // --- Progress ---
    const progressSection = document.getElementById("progress-section");
    const progressTitle = document.getElementById("progress-title");
    if (!userData.fase) {
      progressSection.style.display = 'none';
      progressTitle.style.display = 'none';
    } else {
      const progress = await Auth.getProgress(userData.id);
      renderProgress(progress, userData.id);
    }

    // --- Notifications ---
    await loadNotifications(userData.id);
    setupNotificationListeners(userData.id);

    // --- Logout ---
    document.getElementById("btn-logout").addEventListener("click", async () => {
      await Auth.logout();
      window.location.href = "iniciar-sesion.html";
    });

    // --- Tab title ---
    document.addEventListener("visibilitychange", () => {
      document.title = document.hidden ? "Volvemos pronto..." : "Dashboard | Binary Edge Academy";
    });
  });

  function renderFase1Card(userData) {
    const card = document.getElementById("card-fase1");
    const badge = document.getElementById("badge-fase1");
    const action = document.getElementById("action-fase1");
    const hasAccess = Auth.hasAccess('fase-1');

    if (hasAccess) {
      badge.textContent = 'Activo';
      badge.className = 'card-badge badge-active';
      action.innerHTML = '<a href="acceso-comunidad.html" class="card-action action-primary">' +
        'Acceder al curso' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>' +
        '</a>';
    } else {
      card.classList.add('card-locked');
      badge.textContent = 'Bloqueado';
      badge.className = 'card-badge badge-locked';
      action.innerHTML = '<a href="finalizar-compra.html?plan=fase1" class="card-action action-locked">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' +
        'Adquirir Fase 1 — $9.999 ARS / USD 10' +
        '</a>';
    }

    if (!userData.fase) {
      document.getElementById("welcome-subtitle").textContent = 'Adquiri un curso para comenzar tu camino en trading';
    }
  }

  function renderBotCard(userData) {
    const badge = document.getElementById("badge-bot");
    const action = document.getElementById("action-bot");
    const botActivo = userData.bot_activo;

    if (botActivo) {
      badge.textContent = 'Activo';
      badge.className = 'card-badge badge-active';
      action.innerHTML = '<a href="bot.html" class="card-action action-bot-active">' +
        '<span class="bot-pulse"></span>' +
        'Bot operando 24/7 — Ver detalles' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>' +
        '</a>';
    } else {
      badge.textContent = 'Nuevo';
      badge.className = 'card-badge badge-new';
      action.innerHTML = '<a href="finalizar-compra.html?plan=bot" class="card-action action-outline">' +
        'Suscribirme — $7.500 ARS / USD 5' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>' +
        '</a>';
    }
  }

  function renderComunidadCard(userData) {
    const badge = document.getElementById("badge-comunidad");
    const action = document.getElementById("action-comunidad");
    const card = document.getElementById("card-comunidad");
    const hasAccess = !!userData.comunidad_activa;

    if (hasAccess) {
      badge.textContent = 'Activo';
      badge.className = 'card-badge badge-active';
      action.innerHTML = '<a href="comunidad-privada.html" class="card-action action-primary">' +
        'Entrar a la comunidad' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>' +
        '</a>';
    } else {
      card.classList.add('card-locked');
      badge.textContent = 'Bloqueado';
      badge.className = 'card-badge badge-locked';
      action.innerHTML = '<span class="card-action action-locked">' +
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' +
        'Contacta a soporte para acceder' +
        '</span>';
    }
  }

  function renderProgress(progress, userId) {
    const container = document.getElementById("progress-modules");
    const completed = progress.filter(p => p.completado).length;
    const total = progress.length || 5;
    const pct = Math.round((completed / total) * 100);

    document.getElementById("progress-count").textContent = completed + " / " + total;
    document.getElementById("progress-bar").style.width = pct + "%";

    container.innerHTML = progress.map(p => {
      const name = MODULE_NAMES[p.modulo] || p.modulo;
      const checked = p.completado ? 'checked' : '';
      const doneClass = p.completado ? 'module-done' : '';
      return '<label class="progress-module ' + doneClass + '">' +
        '<input type="checkbox" ' + checked + ' onchange="toggleModule(\'' + p.modulo + '\', this.checked, \'' + userId + '\')">' +
        '<span class="module-check">' +
          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>' +
        '</span>' +
        '<span class="module-name">' + name + '</span>' +
      '</label>';
    }).join('');
  }

  async function toggleModule(modulo, completado, userId) {
    await Auth.updateProgress(userId, modulo, completado);
    const progress = await Auth.getProgress(userId);
    renderProgress(progress, userId);
  }

  // ---- NOTIFICATIONS ----
  async function loadNotifications(userId) {
    const notifications = await Auth.getNotifications(userId);
    const unreadCount = notifications.filter(n => !n.leida).length;
    const badge = document.getElementById("notif-badge");
    const list = document.getElementById("notif-list");

    if (unreadCount > 0) {
      badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }

    if (!notifications.length) {
      list.innerHTML = '<div class="notif-empty">No tienes notificaciones</div>';
      return;
    }

    list.innerHTML = notifications.map(function(n) {
      var tipoIcon = {
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
        success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>',
        warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
      };
      var icon = tipoIcon[n.tipo] || tipoIcon.info;
      var unreadClass = n.leida ? '' : ' notif-unread';
      var timeAgo = getTimeAgo(n.created_at);

      return '<div class="notif-item' + unreadClass + '" data-id="' + n.id + '">' +
        '<div class="notif-icon notif-icon-' + (n.tipo || 'info') + '">' + icon + '</div>' +
        '<div class="notif-content">' +
          '<div class="notif-title">' + escapeHtml(n.titulo) + '</div>' +
          '<div class="notif-message">' + escapeHtml(n.mensaje) + '</div>' +
          '<div class="notif-time">' + timeAgo + '</div>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  function setupNotificationListeners(userId) {
    var bell = document.getElementById("notif-bell");
    var dropdown = document.getElementById("notif-dropdown");
    var wrapper = document.getElementById("notif-wrapper");

    bell.addEventListener("click", function(e) {
      e.stopPropagation();
      dropdown.classList.toggle("open");
    });

    document.addEventListener("click", function(e) {
      if (!wrapper.contains(e.target)) {
        dropdown.classList.remove("open");
      }
    });

    // Mark single notification as read on click
    document.getElementById("notif-list").addEventListener("click", async function(e) {
      var item = e.target.closest('.notif-item');
      if (item && item.classList.contains('notif-unread')) {
        var id = item.dataset.id;
        await Auth.markNotificationRead(id);
        item.classList.remove('notif-unread');
        await loadNotifications(userId);
      }
    });

    // Mark all as read
    document.getElementById("notif-mark-all").addEventListener("click", async function() {
      await Auth.markAllNotificationsRead(userId);
      await loadNotifications(userId);
    });
  }

  function getTimeAgo(dateStr) {
    var now = new Date();
    var date = new Date(dateStr);
    var diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'Hace un momento';
    if (diff < 3600) return 'Hace ' + Math.floor(diff / 60) + ' min';
    if (diff < 86400) return 'Hace ' + Math.floor(diff / 3600) + 'h';
    if (diff < 604800) return 'Hace ' + Math.floor(diff / 86400) + 'd';
    return date.toLocaleDateString('es-AR');
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }
</script>

</body>
</html>
